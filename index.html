<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Posts</title>

  <!-- Usa tu CSS base del widget Flujo Creativo -->
  <link rel="stylesheet" href="/styles.css" />

  <style>
    /* Ajustes mínimos por si faltan tokens del theme base */

    :root {
      --fc-bg: #ffffff;
      --fc-text: #111;
      --fc-muted: #666;
      --fc-border: #e5e7eb;
      --fc-overlay: rgba(0,0,0,.55);
      --fc-dot: rgba(255,255,255,.7);
      --fc-badge-bg: rgba(255,255,255,.9);
      --fc-card-radius: 14px;
      --fc-gap: 8px;
    }

    body { background: var(--fc-bg); color: var(--fc-text); }

    .toolbar { display:flex; flex-direction:column; gap:10px; padding:16px; }
    .toolbar-row { display:flex; gap:10px; align-items:center; flex-wrap:wrap; }

    .btn { padding:8px 14px; border:1px solid var(--fc-border); border-radius:10px; background:#fff; cursor:pointer; }
    .btn[disabled] { opacity:.6; cursor:default; }
    select, input[type="search"] {
      border:1px solid var(--fc-border); border-radius:10px; padding:8px 10px; background:#fff;
    }

    .grid { 
      display:grid; 
      grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
      gap: var(--fc-gap);
      padding: 0 16px 16px;
    }

    .card {
      position:relative;
      overflow:hidden;
      border-radius: var(--fc-card-radius);
      background:#f7f7f7;
      min-height: 220px;
      cursor:pointer;
      border:1px solid var(--fc-border);
    }
    .card .media-wrap { position:relative; width:100%; height:100%; }
    .card img.media, .card video.media { 
      width:100%; height:100%; object-fit:cover; display:block;
    }
    .badge {
      position:absolute; top:8px; right:8px; 
      display:inline-flex; align-items:center; justify-content:center;
      height:24px; padding:0 8px; border-radius:999px;
      background: var(--fc-badge-bg);
      font-size:12px; font-weight:600; color:#111; gap:6px;
      box-shadow: 0 2px 6px rgba(0,0,0,.12);
    }
    .badge + .badge { right:36px; } /* carrusel antes que video */
    .badge-video { width:24px; padding:0; border-radius:999px; }
    .owner-badge {
      position:absolute; top:8px; left:8px;
      width:30px; height:30px; border-radius:6px;
      display:flex; align-items:center; justify-content:center;
      color:#fff; font-size:11px; font-weight:800; letter-spacing:.4px;
      box-shadow: 0 2px 6px rgba(0,0,0,.2);
    }
    .overlay {
      position:absolute; left:0; right:0; bottom:0;
      background: var(--fc-overlay);
      color:#fff; padding:8px 10px;
      transform: translateY(100%); transition: transform .18s ease;
      font-size:12px;
    }
    .card:hover .overlay, .card:focus-within .overlay { transform: translateY(0%); }
    .ovl-title { font-weight:700; font-size:13px; line-height:1.2; }
    .ovl-meta { opacity:.9; margin-top:2px; }

    .loadmore-wrap { display:flex; justify-content:center; padding: 10px 16px 32px; }

    .empty, .error { padding:24px 16px; color: var(--fc-muted); }

    /* Modal */
    .modal { position:fixed; inset:0; background:rgba(0,0,0,.5); display:none; align-items:center; justify-content:center; z-index:50; }
    .modal.open { display:flex; }
    .modal-card {
      width:min(100vw - 24px, 980px); max-height: calc(100vh - 24px);
      background:#fff; border-radius:16px; overflow:hidden; display:flex; flex-direction:column;
    }
    .modal-head { display:flex; align-items:center; justify-content:space-between; padding:10px 12px; border-bottom:1px solid var(--fc-border); }
    .modal-body { position:relative; background:#000; display:flex; align-items:center; justify-content:center; min-height: 420px; }
    .modal-body img, .modal-body video { max-width:100%; max-height:70vh; object-fit:contain; }
    .modal-copy { padding:10px 12px; border-top:1px solid var(--fc-border); font-size:14px; }
    .modal-foot { display:flex; align-items:center; justify-content:space-between; padding:10px 12px; border-top:1px solid var(--fc-border); }
    .nav-btn { position:absolute; top:50%; transform: translateY(-50%); background:rgba(0,0,0,.45); color:#fff; border:none; width:40px; height:40px; border-radius:999px; cursor:pointer; }
    .nav-prev { left:8px; } .nav-next { right:8px; }

    /* Dots carrusel */
    .dots { display:flex; gap:6px; align-items:center; justify-content:center; padding:8px 0; }
    .dot { width:6px; height:6px; border-radius:999px; background: var(--fc-dot); opacity:.5; }
    .dot.active { opacity:1; background:#fff; }

    /* Mobile */
    @media (max-width: 600px){
      .grid { grid-template-columns: repeat(1, minmax(0, 1fr)); }
      .card { min-height: 260px; }
    }
  </style>
</head>
<body>

  <!-- Toolbar -->
  <div class="toolbar">
    <div class="toolbar-row">
      <button class="btn" id="btnRefresh">Refresh</button>

      <select id="selClient">
        <option value="">All Clients</option>
      </select>

      <select id="selProject">
        <option value="">All Projects</option>
      </select>

      <select id="selBrand" disabled>
        <option value="">All Brands</option>
      </select>

      <select id="selPlatform">
        <option value="">All Platforms</option>
      </select>

      <select id="selStatus">
        <option value="published">Published Only</option>
        <option value="all">All Status</option>
      </select>
    </div>

    <div class="toolbar-row">
      <input id="txtSearch" type="search" placeholder="Buscar posts..." />
    </div>
  </div>

  <!-- Grid -->
  <main>
    <div id="grid" class="grid"></div>
    <div class="loadmore-wrap">
      <button id="btnMore" class="btn" style="display:none;">Load more</button>
    </div>
    <div id="msg" class="empty" style="display:none;"></div>
  </main>

  <!-- Modal -->
  <div id="modal" class="modal" aria-hidden="true">
    <div class="modal-card">
      <div class="modal-head">
        <strong id="modalTitle"></strong>
        <button class="btn" id="modalClose">Close</button>
      </div>
      <div class="modal-body" id="modalBody">
        <button class="nav-btn nav-prev" id="prevAsset" aria-label="Prev">◀</button>
        <img id="modalImg" alt="" style="display:none;" />
        <video id="modalVid" controls playsinline style="display:none;"></video>
        <button class="nav-btn nav-next" id="nextAsset" aria-label="Next">▶</button>
      </div>
      <div class="modal-copy" id="modalCopy" style="display:none;"></div>
      <div class="modal-foot">
        <div id="modalMeta" style="font-size:12px; color:#444;"></div>
        <div class="dots" id="modalDots"></div>
      </div>
    </div>
  </div>

<script>
/* =========================
   Estado & referencias
========================= */
const grid = document.getElementById('grid');
const msg  = document.getElementById('msg');

const selClient   = document.getElementById('selClient');
const selProject  = document.getElementById('selProject');
const selBrand    = document.getElementById('selBrand');
const selPlatform = document.getElementById('selPlatform');
const selStatus   = document.getElementById('selStatus');
const txtSearch   = document.getElementById('txtSearch');
const btnMore     = document.getElementById('btnMore');
const btnRefresh  = document.getElementById('btnRefresh');

const modal       = document.getElementById('modal');
const modalTitle  = document.getElementById('modalTitle');
const modalImg    = document.getElementById('modalImg');
const modalVid    = document.getElementById('modalVid');
const modalCopy   = document.getElementById('modalCopy');
const modalDots   = document.getElementById('modalDots');
const modalMeta   = document.getElementById('modalMeta');
const modalClose  = document.getElementById('modalClose');
const prevAsset   = document.getElementById('prevAsset');
const nextAsset   = document.getElementById('nextAsset');

let STATE = {
  posts: [],
  page: 0,
  limit: 12,
  end: false,
  // modal
  currentPost: null,
  currentAssetIdx: 0,
};

/* =========================
   Helpers
========================= */
const escapeHtml = s => String(s||'').replace(/[&<>"']/g, m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[m]));
const uniq = arr => [...new Set(arr.filter(Boolean))];
function deb(fn, ms=250){ let t; return (...a)=>{ clearTimeout(t); t=setTimeout(()=>fn(...a), ms); }; }

/* =========================
   API
========================= */
async function api(path){
  const r = await fetch(path);
  if (!r.ok) {
    const text = await r.text().catch(()=> '');
    throw new Error('API error '+ r.status + ': ' + text.slice(0,300));
  }
  return r.json();
}

async function fetchMeta(){
  const j = await api('/api/grid?meta=1');
  const filters = j.filters || {};

  // Clients / Projects
  fillSelect(selClient,  ['','All Clients'],  filters.clients);
  fillSelect(selProject, ['','All Projects'], filters.projects);

  // Platforms
  fillSelect(selPlatform, ['','All Platforms'], filters.platforms);

  // Brand depende del cliente -> inicialmente vacío
  selBrand.innerHTML = '<option value="">All Brands</option>';
  selBrand.disabled = true;
}

function fillSelect(selectEl, head, values){
  const [firstValue, firstLabel] = head;
  const opts = [`<option value="${escapeHtml(firstValue)}">${escapeHtml(firstLabel)}</option>`];
  (values||[]).forEach(v => opts.push(`<option value="${escapeHtml(v)}">${escapeHtml(v)}</option>`));
  selectEl.innerHTML = opts.join('');
}

/* =========================
   Fetch posts (paginado)
========================= */
function buildQuery(reset=false){
  const p = new URLSearchParams();
  p.set('limit', String(STATE.limit));
  p.set('page',  String(STATE.page));
  p.set('status', selStatus.value || 'published');
  if (selClient.value)   p.set('client', selClient.value);
  if (selProject.value)  p.set('project', selProject.value);
  if (selBrand.value)    p.set('brand', selBrand.value);
  if (selPlatform.value) p.set('platform', selPlatform.value);
  if (txtSearch.value.trim()) p.set('q', txtSearch.value.trim());
  return '/api/grid?' + p.toString();
}

async function loadPosts(reset=false){
  if (reset){
    STATE.page = 0;
    STATE.end  = false;
    STATE.posts = [];
    grid.innerHTML = '';
    btnMore.style.display = 'none';
    msg.style.display = 'none';
    msg.textContent = '';
  }
  if (STATE.end) return;

  const path = buildQuery(reset);
  let data;
  try {
    data = await api(path);
  } catch (err){
    console.error(err);
    msg.style.display = 'block';
    msg.textContent = 'Error cargando posts';
    return;
  }

  const posts = data.posts || [];
  STATE.posts.push(...posts);

  // render
  posts.forEach(p => grid.appendChild(makeCard(p)));

  // has_more
  if (data.has_more) {
    btnMore.style.display = 'inline-flex';
  } else {
    STATE.end = true;
    btnMore.style.display = 'none';
  }

  if (!STATE.posts.length){
    msg.style.display = 'block';
    msg.textContent = 'No results';
  }
}

/* =========================
   Brand depende de Client
========================= */
function syncBrands(){
  const client = selClient.value;
  if (!client) {
    selBrand.disabled = true;
    selBrand.innerHTML = '<option value="">All Brands</option>';
    return;
  }
  // derivar de los posts cargados (fallback) — el backend idealmente
  // puede exponer brandsByClient en /api/grid?meta=1
  const brands = uniq(STATE.posts
    .filter(p => p.client === client)
    .map(p => p.brand));
  selBrand.disabled = false;
  fillSelect(selBrand, ['','All Brands'], brands);
}

/* =========================
   Card (con autoplay, badges)
========================= */
function makeCard(post){
  const el = document.createElement('button');
  el.type = 'button';
  el.className = 'card';
  el.setAttribute('aria-label', post.title || 'post');

  const main = (post.assets && post.assets[0]) || null;

  let mediaHTML = '<div class="media-wrap">';
  if (main?.type === 'video') {
    mediaHTML += `<video class="media" src="${encodeURI(main.url)}" muted playsinline preload="metadata"></video>`;
  } else if (main?.type === 'image') {
    mediaHTML += `<img class="media" src="${encodeURI(main.url)}" alt="${escapeHtml(post.title||'')}" />`;
  } else {
    mediaHTML += `<div class="media" style="display:flex;align-items:center;justify-content:center;color:#888;font-size:12px;">No image</div>`;
  }
  mediaHTML += '</div>';

  // badges
  let badges = '';
  if (Array.isArray(post.assets) && post.assets.length > 1) {
    badges += `<span class="badge" title="Carrusel IG">IG</span>`;
  }
  if (main?.type === 'video') {
    badges += `<span class="badge badge-video" title="Video">▶</span>`;
  }
  const ownerInitials = (post.owner_initials || '').slice(0,2) || '??';
  const ownerColor = post.owner_color || '#6B7280';
  const ownerBadge = `<span class="owner-badge" style="background:${ownerColor}">${escapeHtml(ownerInitials)}</span>`;

  // overlay
  const ovlTitle = escapeHtml(post.title || '');
  const ovlMeta  = [
    post.client || '',
    post.project ? `· ${post.project}` : '',
    post.date ? `· ${post.date}` : ''
  ].filter(Boolean).join(' ');
  const overlay = `
    <div class="overlay">
      <div class="ovl-title">${ovlTitle}</div>
      <div class="ovl-meta">${escapeHtml(ovlMeta)}</div>
    </div>`;

  el.innerHTML = ownerBadge + mediaHTML + badges + overlay;

  // autoplay on hover
  el.addEventListener('mouseenter', () => {
    const v = el.querySelector('video.media');
    if (v) v.play().catch(()=>{});
  });
  el.addEventListener('mouseleave', () => {
    const v = el.querySelector('video.media');
    if (v) { v.pause(); v.currentTime = 0; }
  });

  // open modal
  el.addEventListener('click', ()=> openModal(post));

  return el;
}

/* =========================
   Modal (copy + carrusel)
========================= */
function openModal(post){
  STATE.currentPost = post;
  STATE.currentAssetIdx = 0;

  modalTitle.textContent = post.title || '';
  renderModalAsset();
  renderModalCopy();
  renderModalDots();

  const meta = [post.date, post.client, post.project].filter(Boolean).join(' · ');
  modalMeta.textContent = meta;

  modal.classList.add('open');
  modal.setAttribute('aria-hidden','false');
}
function closeModal(){
  modal.classList.remove('open');
  modal.setAttribute('aria-hidden','true');
  modalVid.pause(); modalVid.src = ''; modalImg.src = '';
}

function renderModalAsset(){
  const a = (STATE.currentPost.assets || [])[STATE.currentAssetIdx];
  if (!a){ modalImg.style.display='none'; modalVid.style.display='none'; return; }

  if (a.type === 'video'){
    modalVid.style.display='block';
    modalImg.style.display='none';
    if (modalVid.src !== a.url) modalVid.src = a.url;
    modalVid.play().catch(()=>{});
  } else {
    modalImg.style.display='block';
    modalVid.style.display='none';
    modalVid.pause();
    if (modalImg.src !== a.url) modalImg.src = a.url;
  }
}
function renderModalCopy(){
  const copy = STATE.currentPost.copy || '';
  if (copy.trim()){
    modalCopy.style.display = 'block';
    modalCopy.textContent = copy;
  } else {
    modalCopy.style.display = 'none';
    modalCopy.textContent = '';
  }
}
function renderModalDots(){
  const n = (STATE.currentPost.assets||[]).length;
  modalDots.innerHTML = '';
  if (n <= 1) return;
  for (let i=0;i<n;i++){
    const d = document.createElement('span');
    d.className = 'dot' + (i===STATE.currentAssetIdx ? ' active':'');
    d.addEventListener('click', ()=>{ STATE.currentAssetIdx = i; renderModalAsset(); renderModalDots(); });
    modalDots.appendChild(d);
  }
}
function next(){ const n=(STATE.currentPost.assets||[]).length; if(!n) return; STATE.currentAssetIdx=(STATE.currentAssetIdx+1)%n; renderModalAsset(); renderModalDots(); }
function prev(){ const n=(STATE.currentPost.assets||[]).length; if(!n) return; STATE.currentAssetIdx=(STATE.currentAssetIdx-1+n)%n; renderModalAsset(); renderModalDots(); }

modalClose.addEventListener('click', closeModal);
modal.addEventListener('click', e=>{ if(e.target===modal) closeModal(); });
nextAsset.addEventListener('click', next);
prevAsset.addEventListener('click', prev);
document.addEventListener('keydown', e=>{
  if (modal.classList.contains('open')){
    if (e.key==='Escape') closeModal();
    if (e.key==='ArrowRight') next();
    if (e.key==='ArrowLeft')  prev();
  }
});

/* =========================
   Eventos UI
========================= */
btnRefresh.addEventListener('click', async ()=>{
  await fetchMeta();
  await loadPosts(true);
});

btnMore.addEventListener('click', async ()=>{
  STATE.page += 1;
  await loadPosts(false);
});

selClient.addEventListener('change', ()=>{
  syncBrands();
  loadPosts(true);
});
selProject.addEventListener('change', ()=> loadPosts(true));
selBrand.addEventListener('change',   ()=> loadPosts(true));
selPlatform.addEventListener('change',()=> loadPosts(true));
selStatus.addEventListener('change',  ()=> loadPosts(true));
txtSearch.addEventListener('input', deb(()=> loadPosts(true), 250));

/* =========================
   Init
========================= */
(async function init(){
  try {
    await fetchMeta();
    await loadPosts(true);
  } catch (err){
    console.error(err);
    msg.style.display='block';
    msg.textContent = 'Error cargando posts';
  }
})();
</script>
</body>
</html>
