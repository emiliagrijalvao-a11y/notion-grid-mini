<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Notion Grid Widget</title>
  <style>
    :root{
      --bg:#ffffff; --text:#111; --muted:#6b7280; --border:#e6e6e6;
      --chip:#f3f4f6; --chip-text:#111; --link-dark:#1c2f7a;
      --bio-avatar-size:84px;
    }
    *{box-sizing:border-box}
    html,body{background:var(--bg);color:var(--text);font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Inter;line-height:1.45}
    a{color:inherit;text-decoration:none}
    .wrap{max-width:1120px;margin:0 auto;padding:16px}
    .toolbar{display:flex;align-items:center;justify-content:space-between;gap:12px;position:relative}
    button{cursor:pointer}
    #btnRefresh{padding:10px 14px;border-radius:12px;border:1px solid var(--border);background:#111;color:#fff;font-weight:700}
    .controls{display:flex;gap:12px;align-items:center;flex-wrap:wrap}
    .dd{position:relative}
    .dd>button{padding:10px 14px;border:1px solid #dcdcdc;background:#fff;border-radius:12px;font-weight:600}
    .dd-menu{position:absolute;top:48px;left:0;min-width:220px;background:#fff;border:1px solid #e6e6e6;border-radius:12px;box-shadow:0 10px 24px rgba(0,0,0,.08);display:none;z-index:10}
    .dd.open .dd-menu{display:block}
    .dd-menu button{display:block;width:100%;padding:10px 14px;text-align:left;background:#fff;border:0}
    .dd-menu button:hover{background:#f6f6f6}

    .btn-ellipsis{width:36px;height:36px;border-radius:12px;background:#f3f3f3;border:1px solid #d9d9d9;display:inline-flex;align-items:center;justify-content:center}
    .btn-ellipsis i{width:6px;height:6px;border-radius:50%;background:#333;box-shadow:10px 0 0 #333, -10px 0 0 #333}

    .bio-card{position:absolute;top:72px;right:16px;width:360px;max-width:90vw;background:#fff;border:1px solid #eaeaea;border-radius:16px;padding:16px;box-shadow:0 10px 30px rgba(0,0,0,.08);display:none}
    .bio-card.open{display:block}
    .switch{position:relative;display:inline-flex;align-items:center;gap:10px}
    .switch input{display:none}
    .switch .track{width:46px;height:26px;border-radius:999px;background:#111;position:relative}
    .switch .dot{position:absolute;top:3px;left:3px;width:20px;height:20px;border-radius:50%;background:#fff;transition:left .2s}
    .switch input:not(:checked)+.track{background:#d1d1d1}
    .switch input:not(:checked)+.track .dot{left:23px}
    .bio-head{display:flex;align-items:center;gap:12px;margin-bottom:8px}
    .bio-avatar{width:var(--bio-avatar-size);height:var(--bio-avatar-size);border-radius:999px;object-fit:cover;background:#eee;flex:0 0 var(--bio-avatar-size)}
    .bio-username{font-size:22px;font-weight:800;line-height:1.1}
    .bio-name{font-weight:600;margin-top:2px}
    .bio-text{margin:10px 0 8px;white-space:pre-line}
    .bio-link a{color:var(--link-dark);text-decoration:underline}
    .tip{font-size:12.5px;color:#6b6b6b;line-height:1.35}

    /* Grid */
    .grid{display:grid;grid-template-columns:repeat(3,1fr);gap:12px;margin-top:14px}
    @media (max-width:920px){.grid{grid-template-columns:repeat(2,1fr)}}
    @media (max-width:560px){.grid{grid-template-columns:1fr}}
    .card{position:relative;background:#f3f3f3;border:1px solid var(--border);border-radius:12px;overflow:hidden;aspect-ratio:1/1}
    .card img, .card video{width:100%;height:100%;object-fit:cover;display:block}
    .pin{position:absolute;top:8px;right:8px;width:26px;height:26px;border-radius:8px;background:rgba(255,255,255,.95);border:1px solid #ddd;display:flex;align-items:center;justify-content:center}
    .pin:before{content:"üìå";font-size:16px}
    .play{position:absolute;bottom:10px;left:10px;width:28px;height:28px;border-radius:8px;background:rgba(0,0,0,.75);color:#fff;display:flex;align-items:center;justify-content:center;font-size:14px}
  </style>
</head>
<body>
  <div class="wrap">

    <!-- Barra superior -->
    <div class="toolbar">
      <div class="controls">
        <button id="btnRefresh">Refresh</button>

        <div class="dd" id="ddPlatforms">
          <button id="btnPlatforms">All Platforms ‚ñæ</button>
          <div class="dd-menu">
            <button data-platform="all">All Platforms</button>
            <button data-platform="Instagram">Instagram</button>
            <button data-platform="Tik Tok">Tik Tok</button>
            <button data-platform="Other">Other</button>
          </div>
        </div>

        <div class="dd" id="ddStatus">
          <button id="btnStatus">All Status ‚ñæ</button>
          <div class="dd-menu">
            <button data-status="all">All Status</button>
            <button data-status="Idea">Idea</button>
            <button data-status="Draft">Draft</button>
            <button data-status="In progress">In progress</button>
            <button data-status="Done">Done</button>
          </div>
        </div>
      </div>

      <button id="btnBio" class="btn-ellipsis" aria-label="Open Bio"><i></i></button>

      <!-- Bio -->
      <div id="bioCard" class="bio-card">
        <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:12px">
          <div class="switch">
            <label style="font-weight:700">Show Bio</label>
            <input id="toggleBio" type="checkbox" checked />
            <div class="track"><div class="dot"></div></div>
          </div>
        </div>

        <div class="bio-head">
          <img id="bioAvatar" class="bio-avatar" alt=""/>
          <div>
            <div id="bioUsername" class="bio-username">@your_username</div>
            <div id="bioName" class="bio-name">Grid Content Planner</div>
          </div>
        </div>

        <div id="bioText" class="bio-text">Welcome to Flujo Creativo / widget ‚òÅÔ∏è
üñº IG grid planner for your feed
Inquire below ‚Üì</div>
        <div class="bio-link"><a id="bioUrl" href="#" target="_blank" rel="noopener">websitelink.com</a></div>

        <hr style="margin:14px 0">
        <div class="tip">
          Want to customize your bio or highlights? Go to your Account page, find your widget, click Edit.
        </div>
      </div>
    </div>

    <!-- Grid -->
    <div id="grid" class="grid"></div>
  </div>

<script>
// ------------ Dropdowns ------------
function setupDropdown(ddId, btnId){
  const dd = document.getElementById(ddId);
  const btn = document.getElementById(btnId);
  btn.addEventListener('click', (e)=>{ e.stopPropagation(); dd.classList.toggle('open'); });
}
setupDropdown('ddPlatforms','btnPlatforms');
setupDropdown('ddStatus','btnStatus');
document.addEventListener('click', ()=> {
  document.querySelectorAll('.dd.open').forEach(el=>el.classList.remove('open'));
});

// --------- Estado de filtros ---------
let RAW_ITEMS = [];
let currentPlatform = 'all';
let currentStatus = 'all';

window.filterByPlatform = (v)=>{
  currentPlatform = v;
  document.getElementById('btnPlatforms').textContent = (v==='all'?'All Platforms':v)+' ‚ñæ';
  renderGrid();
};
window.filterByStatus = (v)=>{
  currentStatus = v;
  document.getElementById('btnStatus').textContent = (v==='all'?'All Status':v)+' ‚ñæ';
  renderGrid();
};

// Menu clicks
document.querySelectorAll('#ddPlatforms .dd-menu button').forEach(b=>{
  b.addEventListener('click', ()=> window.filterByPlatform(b.dataset.platform || 'all'));
});
document.querySelectorAll('#ddStatus .dd-menu button').forEach(b=>{
  b.addEventListener('click', ()=> window.filterByStatus(b.dataset.status || 'all'));
});

// ------------- BIO panel -------------
const bioCard = document.getElementById('bioCard');
document.getElementById('btnBio').addEventListener('click', (e)=>{ e.stopPropagation(); bioCard.classList.toggle('open'); });
document.addEventListener('click', ()=> bioCard.classList.remove('open'));
document.getElementById('toggleBio').addEventListener('change', (e)=>{
  const on = e.target.checked;
  bioCard.querySelector('.bio-head').style.display = on?'flex':'none';
  bioCard.querySelector('#bioText').style.display = on?'block':'none';
  bioCard.querySelector('.bio-link').style.display = on?'block':'none';
});

// Carga ENV para Bio
(async function loadBio(){
  try{
    const r = await fetch('/api/health');
    const h = await r.json();
    document.getElementById('bioUsername').textContent = h.bioUsername || '@flujocreativo';
    document.getElementById('bioName').textContent     = h.bioName || 'Grid Content Planner';

    const txt = h.bioText || 'Welcome to Flujo Creativo / widget ‚òÅÔ∏è\nüñº IG grid planner for your feed\nInquire below ‚Üì';
    document.getElementById('bioText').textContent = txt;

    const a = document.getElementById('bioUrl');
    const url = h.bioUrl || 'https://websitelink.com';
    a.href = url;
    a.textContent = url.replace(/^https?:\/\//,'');
    const img = document.getElementById('bioAvatar');
    if(h.bioAvatar){ img.src = h.bioAvatar; img.style.display='block'; } else { img.style.display='none'; }
  }catch(_){}
})();

// --------------- GRID ---------------
function renderGrid(){
  const wrap = document.getElementById('grid');
  wrap.innerHTML = "";
  const filtered = RAW_ITEMS.filter(it=>{
    const p = currentPlatform==='all' || it.platform===currentPlatform || it.platforms?.includes(currentPlatform);
    const s = currentStatus==='all' || (it.status||'')===currentStatus;
    return p && s;
  });

  for(const it of filtered){
    const card = document.createElement('a');
    card.className = 'card';
    card.href = it.link || '#';
    card.target = it.link ? '_blank' : '_self';
    card.rel = 'noopener';

    if (it.isVideo) {
      const v = document.createElement('img');
      v.alt = it.title || '';
      v.src = it.image || 'data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///ywAAAAAAQABAAACAUwAOw==';
      card.appendChild(v);
      const play = document.createElement('div');
      play.className = 'play';
      play.textContent = '‚ñ∂';
      card.appendChild(play);
    } else {
      const img = document.createElement('img');
      img.alt = it.title || '';
      img.loading = 'lazy';
      img.src = it.image || 'data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///ywAAAAAAQABAAACAUwAOw==';
      card.appendChild(img);
    }

    if (it.pinned) {
      const pin = document.createElement('div');
      pin.className = 'pin';
      card.appendChild(pin);
    }

    wrap.appendChild(card);
  }
}

async function loadGrid(){
  const r = await fetch('/api/grid');
  const data = await r.json();
  RAW_ITEMS = data.items || [];
  renderGrid();
}
window.reloadGrid = loadGrid;

document.getElementById('btnRefresh').addEventListener('click', ()=> {
  (window.reloadGrid && window.reloadGrid()) || location.reload();
});

loadGrid();
</script>
</body>
</html>
