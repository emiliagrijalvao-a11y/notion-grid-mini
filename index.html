<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Posts</title>
  <link rel="stylesheet" href="/styles.css?v=1" />
</head>
<body>

  <!-- Toolbar -->
  <header class="toolbar">
    <div class="toolbar-left">
      <h1 class="title">Posts <span id="count" class="count"></span></h1>
    </div>
    <div class="toolbar-right">
      <button id="btnRefresh" class="btn">Refresh</button>
      <input id="txtSearch" class="search" type="search" placeholder="Buscar posts..." />
    </div>
  </header>

  <!-- Filters -->
  <section class="filters">
    <div class="filters-row">
      <select id="selClient"  class="filter"><option value="">All Clients</option></select>
      <select id="selProject" class="filter"><option value="">All Projects</option></select>
      <select id="selBrand"   class="filter" disabled><option value="">All Brands</option></select>
      <select id="selPlatform" class="filter"><option value="">All Platforms</option></select>
      <select id="selStatus" class="filter">
        <option value="published">Published Only</option>
        <option value="all">All Status</option>
      </select>
    </div>
    <div id="chips" class="chips"></div>
  </section>

  <!-- Grid -->
  <main>
    <div id="grid" class="grid"></div>
    <div class="loadmore-wrap">
      <button id="btnMore" class="btn" style="display:none;">Load more</button>
    </div>
  </main>

  <!-- Modal -->
  <div id="modal" class="modal" hidden>
    <div class="modal-content">
      <button id="modalClose" class="btn btn-ghost" aria-label="Close">Ã—</button>
      <div class="modal-header"><h2 id="modalTitle"></h2></div>
      <div class="modal-body">
        <img id="modalImg" class="modal-media" alt="" />
        <video id="modalVid" class="modal-media" controls playsinline hidden></video>
        <div id="modalCopy" class="modal-copy" hidden></div>
        <div id="modalDots" class="dots" hidden></div>
      </div>
      <div class="modal-nav modal-prev" role="button" aria-label="Previous">&#10094;</div>
      <div class="modal-nav modal-next" role="button" aria-label="Next">&#10095;</div>
    </div>
  </div>

<script>
/* ========= State ========= */
let ALL = [];
let FILTERED = [];
let PAGE = 1;
const PAGE_SIZE = 12; // carga inicial 12
let CURRENT_POST = null;
let CURRENT_ASSET = 0;

/* ========= DOM ========= */
const selProject  = document.getElementById('selProject');
const selClient   = document.getElementById('selClient');
const selBrand    = document.getElementById('selBrand');
const selPlatform = document.getElementById('selPlatform');
const selStatus   = document.getElementById('selStatus');
const txtSearch   = document.getElementById('txtSearch');
const chips       = document.getElementById('chips');
const grid        = document.getElementById('grid');
const countEl     = document.getElementById('count');
const btnMore     = document.getElementById('btnMore');
const btnRefresh  = document.getElementById('btnRefresh');

const modal       = document.getElementById('modal');
const modalClose  = document.getElementById('modalClose');
const modalTitle  = document.getElementById('modalTitle');
const modalImg    = document.getElementById('modalImg');
const modalVid    = document.getElementById('modalVid');
const modalCopy   = document.getElementById('modalCopy');
const modalDots   = document.getElementById('modalDots');
const navPrev     = document.querySelector('.modal-prev');
const navNext     = document.querySelector('.modal-next');

/* ========= Utils ========= */
const debounce=(fn,ms=250)=>{let t;return(...a)=>{clearTimeout(t);t=setTimeout(()=>fn(...a),ms)}}
const uniq = arr => [...new Set(arr.filter(Boolean))];
const esc  = s => String(s||"").replace(/[&<>"']/g,m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[m]));

/* ========= Fetch ========= */
async function fetchMeta() {
  const r = await fetch('/api/grid?meta=1');
  if(!r.ok) throw new Error('No pude leer filtros');
  const { filters } = await r.json();

  fillSelect(selClient, filters.clients, 'All Clients');
  fillSelect(selProject, filters.projects, 'All Projects');
  fillSelect(selPlatform, filters.platforms, 'All Platforms');
  selBrand.disabled = true; // depende de client
}

async function fetchPosts(reset=true) {
  if (reset) { PAGE=1; FILTERED=[]; grid.innerHTML=''; btnMore.style.display='none'; }
  const params = new URLSearchParams({
    limit: PAGE_SIZE.toString(),
    page: (PAGE-1).toString(),
    status: selStatus.value || 'published',
    q: txtSearch.value.trim(),
    client: selClient.value,
    project: selProject.value,
    brand: selBrand.value,
    platform: selPlatform.value
  });
  const r = await fetch('/api/grid?'+params.toString());
  if(!r.ok){ grid.innerHTML='<div class="error">Error cargando posts</div>'; return; }
  const json = await r.json();
  const posts = json.posts || [];
  ALL = PAGE===1 ? posts : ALL.concat(posts);
  FILTERED = ALL.slice();
  renderChips();
  renderGrid();
  if (json.has_more) btnMore.style.display='inline-flex';
}

function fillSelect(el, items, label){
  el.innerHTML = `<option value="">${label}</option>` + (items||[]).map(x=>`<option value="${esc(x)}">${esc(x)}</option>`).join('');
}

/* ========= Filters ========= */
function onClientChange() {
  selBrand.disabled = !selClient.value;
  selBrand.innerHTML = '<option value="">All Brands</option>';
  if (!selClient.value) return;
  // construir marcas a partir de posts ya recibidos (rÃ¡pido)
  const brands = uniq(ALL.filter(p=>p.client===selClient.value).map(p=>p.brand).filter(Boolean));
  selBrand.innerHTML += brands.map(b=>`<option value="${esc(b)}">${esc(b)}</option>`).join('');
}

function renderChips(){
  const parts=[];
  if (selClient.value)  parts.push(chip('Client', selClient.value,  ()=>{selClient.value=''; onClientChange(); fetchPosts(true);}));
  if (selProject.value) parts.push(chip('Project',selProject.value, ()=>{selProject.value=''; fetchPosts(true);}));
  if (selBrand.value)   parts.push(chip('Brand',  selBrand.value,   ()=>{selBrand.value=''; fetchPosts(true);}));
  if (selPlatform.value)parts.push(chip('Platform',selPlatform.value,()=>{selPlatform.value=''; fetchPosts(true);}));
  if (txtSearch.value)  parts.push(chip('q',      txtSearch.value,  ()=>{txtSearch.value=''; fetchPosts(true);}));
  if (selStatus.value==='published') parts.push(`<span class="chip chip-muted">Published Only</span>`);
  chips.innerHTML = parts.join('');
}
function chip(label,val,rm){const id='c_'+Math.random().toString(36).slice(2); queueMicrotask(()=>{const b=document.getElementById(id); b&&b.addEventListener('click',rm)}); return `<span class="chip">${esc(label)}: ${esc(val)} <button id="${id}" class="chip-x">Ã—</button></span>`;}

/* ========= Grid ========= */
function renderGrid(){
  countEl.textContent = ALL.length ? `(${ALL.length})` : '';
  if (!ALL.length){ grid.innerHTML='<div class="empty">No results</div>'; return; }
  const slice = ALL.slice(0, PAGE*PAGE_SIZE);
  grid.innerHTML='';
  slice.forEach(p=>grid.appendChild(card(p)));
}

function card(post){
  const el = document.createElement('button');
  el.className='card'; el.type='button'; el.setAttribute('aria-label', post.title||'post');

  const main = (post.assets && post.assets[0]) || null;
  const ownerInitials = (post.owner_initials || '').toUpperCase().slice(0,2);
  const ownerStyle = post.owner_color ? `style="background:${post.owner_color}"` : '';

  let mediaHTML = `<div class="media-wrap">`;
  if (main && main.type==='video'){
    mediaHTML += `<video class="media" src="${encodeURI(main.url)}" muted playsinline preload="metadata"></video>`;
  } else if (main){
    mediaHTML += `<img class="media" src="${encodeURI(main.url)}" alt="${esc(post.title||'')}" loading="lazy" />`;
  } else {
    mediaHTML += `<div class="media media-ph">No image</div>`;
  }
  mediaHTML += `</div>`;

  el.innerHTML = `
    ${ownerInitials?`<span class="owner-badge" ${ownerStyle}>${esc(ownerInitials)}</span>`:''}
    ${mediaHTML}
    ${main && main.type==='video' ? `<span class="badge badge-video">â–¶</span>`:''}
    ${post.assets && post.assets.length>1 ? `<span class="badge badge-carousel">IG</span>`:''}
    ${post.pinned ? `<span class="badge badge-pin">ðŸ“Œ</span>`:''}
    <div class="overlay">
      <div class="ovl-title">${esc(post.title||'')}</div>
      <div class="ovl-meta">${esc(post.client||'')}${post.project?' Â· '+esc(post.project):''}${post.date?' Â· '+esc(post.date):''}</div>
    </div>
  `;

  if (main && main.type==='video'){
    el.addEventListener('mouseenter', ()=>{const v=el.querySelector('video'); v&&v.play().catch(()=>{})});
    el.addEventListener('mouseleave', ()=>{const v=el.querySelector('video'); v&&v.pause()});
  }

  el.addEventListener('click', ()=>openModal(post));
  return el;
}

/* ========= Modal ========= */
function openModal(post){
  CURRENT_POST = post; CURRENT_ASSET = 0;
  modalTitle.textContent = post.title || '';
  showAsset();
  const copy = post.copy || '';
  if (copy){ modalCopy.textContent = copy; modalCopy.hidden=false; } else { modalCopy.hidden=true; }
  if (post.assets && post.assets.length>1){ renderDots(post.assets.length); modalDots.hidden=false; } else { modalDots.hidden=true; }
  modal.hidden=false;
}
function showAsset(){
  const a = (CURRENT_POST.assets||[])[CURRENT_ASSET];
  if (!a) return;
  if (a.type==='video'){
    modalVid.src=a.url; modalVid.hidden=false; modalImg.hidden=true; modalVid.play().catch(()=>{});
  } else {
    modalImg.src=a.url; modalImg.hidden=false; modalVid.hidden=true; modalVid.pause();
  }
  highlightDot(CURRENT_ASSET);
}
function closeModal(){ modal.hidden=true; modalVid.pause(); modalVid.currentTime=0; }
modalClose.onclick = closeModal;
modal.addEventListener('click', (e)=>{ if (e.target===modal) closeModal(); });
document.addEventListener('keydown', (e)=>{ if(e.key==='Escape'&&!modal.hidden) closeModal(); if(e.key==='ArrowRight') next(); if(e.key==='ArrowLeft') prev(); });
navNext.addEventListener('click', next);
navPrev.addEventListener('click', prev);
function next(){ if(!CURRENT_POST) return; const n=(CURRENT_ASSET+1)%(CURRENT_POST.assets.length||1); CURRENT_ASSET=n; showAsset(); }
function prev(){ if(!CURRENT_POST) return; const len=CURRENT_POST.assets.length||1; const n=(CURRENT_ASSET-1+len)%len; CURRENT_ASSET=n; showAsset(); }
function renderDots(n){ modalDots.innerHTML = Array.from({length:n},(_,i)=>`<span class="dot" data-i="${i}"></span>`).join(''); modalDots.querySelectorAll('.dot').forEach(d=>d.addEventListener('click',()=>{CURRENT_ASSET=+d.dataset.i; showAsset();})); }
function highlightDot(i){ modalDots.querySelectorAll('.dot').forEach((d,idx)=>d.classList.toggle('active', idx===i)); }

/* ========= Wire-up ========= */
selClient.addEventListener('change', ()=>{ onClientChange(); fetchPosts(true); });
selProject.addEventListener('change', ()=>fetchPosts(true));
selBrand.addEventListener('change',   ()=>fetchPosts(true));
selPlatform.addEventListener('change',()=>fetchPosts(true));
selStatus.addEventListener('change',  ()=>fetchPosts(true));
txtSearch.addEventListener('input', debounce(()=>fetchPosts(true), 250));
btnRefresh.addEventListener('click', ()=>{ localStorage.removeItem('posts-cache'); fetchMeta().then(()=>fetchPosts(true)); });
btnMore.addEventListener('click', ()=>{ PAGE+=1; fetchPosts(false); });

/* ========= Init ========= */
(async function init(){
  await fetchMeta();
  await fetchPosts(true);
})();
</script>
</body>
</html>
