<!doctype html>
<html lang="es">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Grid</title>
    <style>
      /* ——— Tema blanco + vista angosta tipo Instagram ——— */
      :root{
        --ink:#111;
        --muted:#6b7280;
        --line:#e5e7eb;
        --ghost:#f4f4f5;
      }
      *{box-sizing:border-box;margin:0;padding:0}
      html,body{background:#fff;color:var(--ink);font-family:-apple-system,BlinkMacSystemFont,Inter,Segoe UI,Roboto,Helvetica,Arial,sans-serif}
      .wrap{max-width:975px; margin:0 auto; padding:16px}

      /* ——— Top bar ——— */
      .top{
        display:flex;
        align-items:center;
        gap:12px;
      }
      .grid-icon{
        width:28px;height:28px;display:inline-grid;grid-template-columns:repeat(3,1fr);
        gap:3px; cursor:default;
      }
      .grid-icon span{background:var(--ink); width:100%; height:100%;}
      .controls{display:flex; gap:12px; margin-left:auto; align-items:center}
      .btn{
        padding:10px 14px; border:1px solid var(--line); background:#fff; border-radius:12px; cursor:pointer;
      }
      .btn:active{transform:translateY(1px)}
      .select{position:relative}
      .select-btn{padding:10px 14px; border:1px solid var(--line); background:#fff; border-radius:12px; cursor:pointer; min-width:170px; text-align:left}
      .menu{
        position:absolute; top:42px; left:0; z-index:20; background:#fff; border:1px solid var(--line); border-radius:12px; box-shadow:0 8px 30px rgba(0,0,0,.08); min-width:220px; display:none;
      }
      .menu.open{display:block}
      .menu .item{display:flex; align-items:center; gap:10px; padding:10px 12px; cursor:pointer}
      .menu .item:hover{background:var(--ghost)}
      .menu .note{font-size:12px; color:var(--muted); padding:10px 12px; border-top:1px solid var(--line)}
      .kebab{position:relative}
      .kebab-btn{width:40px; height:40px; border:1px solid var(--line); background:#fff; border-radius:12px; font-size:20px; line-height:1; cursor:pointer}

      /* Línea divisoria entre controles y grid */
      .rule{height:1px; background:var(--line); margin:14px 0 16px}

      /* ——— Bio / Highlights (toggle en menú) ——— */
      .bio{display:none; margin:4px 0 14px}
      .bio.show{display:block}
      .bio .username{font-weight:700; font-size:28px; margin-bottom:10px}
      .bio .text{color:var(--ink); white-space:pre-line; line-height:1.5; margin-bottom:8px}
      .bio a{color:#2563eb; text-decoration:none}
      .highlights{display:flex; gap:10px; margin-top:12px}
      .hl{width:66px; height:66px; border:1px solid var(--line); border-radius:50%; background:#fafafa}

      /* ——— Grid 3 columnas SIEMPRE (web y móvil) ——— */
      .grid{
        display:grid; grid-template-columns:repeat(3, 1fr); gap:12px;
      }
      .tile{
        position:relative;
        width:100%;
        aspect-ratio:4/5;          /* 1080x1350 */
        background:#eee;
        overflow:hidden;           /* sin bordes, sin radios — IG */
      }
      .tile img, .tile video{
        width:100%; height:100%; object-fit:cover; display:block;
      }

      /* overlay meta (aparece al pasar) */
      .meta{
        position:absolute; left:0; right:0; bottom:0;
        padding:10px 10px 8px;
        color:#fff; font-size:12px; line-height:1.2;
        background:linear-gradient(to top, rgba(0,0,0,.55), rgba(0,0,0,0));
        opacity:0; transition:opacity .2s ease;
        display:flex; justify-content:space-between; align-items:flex-end;
      }
      .tile:hover .meta{opacity:1}

      /* Pin estilo IG */
      .pin{
        position:absolute; top:8px; right:8px; width:22px; height:22px;
        border-radius:50%; background:rgba(17,17,17,.85); color:#fff;
        display:grid; place-items:center; font-size:13px; box-shadow:0 2px 6px rgba(0,0,0,.25);
      }

      /* chips que aparecen en algunos posts (opcional) */
      .chips{position:absolute; bottom:52px; left:8px; display:flex; gap:6px}
      .chip{
        font-size:11px; padding:4px 6px; background:rgba(17,17,17,.72); color:#fff; border-radius:6px
      }

      /* utilidades */
      .hidden{display:none}
    </style>
  </head>
  <body>
    <div class="wrap">
      <!-- Top bar -->
      <div class="top">
        <div class="grid-icon" aria-hidden="true" title="Grid">
          <span></span><span></span><span></span>
          <span></span><span></span><span></span>
          <span></span><span></span><span></span>
        </div>

        <div class="controls">
          <button id="refreshBtn" class="btn">Refresh</button>

          <div class="select" id="platformSelect">
            <button class="select-btn" id="platformBtn">All Platforms ▾</button>
            <div class="menu" id="platformMenu"></div>
          </div>

          <div class="select" id="statusSelect">
            <button class="select-btn" id="statusBtn">All Status ▾</button>
            <div class="menu" id="statusMenu"></div>
          </div>

          <div class="kebab">
            <button class="kebab-btn" id="moreBtn">⋯</button>
            <div class="menu" id="moreMenu" style="right:0; left:auto;">
              <label class="item"><input type="checkbox" id="showBio" />&nbsp; Show Bio</label>
              <label class="item"><input type="checkbox" id="showHighlights" />&nbsp; Show Highlights</label>
              <div class="note">
                Want to customize your bio or highlights? Go to your Account page, find your widget, click Edit.
              </div>
            </div>
          </div>
        </div>
      </div>

      <div class="rule"></div>

      <!-- Bio (se muestra con el toggle) -->
      <section id="bio" class="bio">
        <div class="username">@your_username</div>
        <div class="text">
Your Display Name
Helping creators turn skills into income ✨
🧱 Serving clients globally
🧠 Tips to build income streams
👇 Start your journey here
        </div>
        <a href="#" target="_blank" rel="noopener">websitelink.com</a>

        <div id="highlights" class="highlights hidden" aria-hidden="true">
          <div class="hl"></div><div class="hl"></div><div class="hl"></div><div class="hl"></div>
        </div>
      </section>

      <!-- Estado / errores -->
      <div id="state" class="hidden" style="margin:12px 0; padding:12px; background:#fee2e2; color:#991b1b; border:1px solid #fecaca; border-radius:10px;"></div>

      <!-- Grid -->
      <div id="grid" class="grid" aria-live="polite"></div>
    </div>

    <script>
      const stateEl = document.getElementById("state");
      const gridEl  = document.getElementById("grid");

      const platformBtn = document.getElementById("platformBtn");
      const statusBtn   = document.getElementById("statusBtn");
      const platformMenu= document.getElementById("platformMenu");
      const statusMenu  = document.getElementById("statusMenu");

      const moreBtn     = document.getElementById("moreBtn");
      const moreMenu    = document.getElementById("moreMenu");
      const refreshBtn  = document.getElementById("refreshBtn");

      const bioBox      = document.getElementById("bio");
      const showBioCb   = document.getElementById("showBio");
      const showHlCb    = document.getElementById("showHighlights");
      const hlBox       = document.getElementById("highlights");

      let ALL_ITEMS = [];
      let currentPlatform = "All Platforms";
      let currentStatus   = "All Status";

      function fmtDate(iso){
        if(!iso) return "";
        const d = new Date(iso);
        const dd = String(d.getDate()).padStart(2,"0");
        const mm = String(d.getMonth()+1).padStart(2,"0");
        const yy = d.getFullYear();
        return `${dd}/${mm}/${yy}`;
      }

      function closeAllMenus(){
        document.querySelectorAll(".menu").forEach(m => m.classList.remove("open"));
      }

      document.addEventListener("click", (e)=>{
        if(!e.target.closest(".select") && !e.target.closest(".kebab")) closeAllMenus();
      });

      platformBtn.addEventListener("click", (e)=>{
        e.stopPropagation();
        closeAllMenus();
        platformMenu.classList.toggle("open");
      });
      statusBtn.addEventListener("click", (e)=>{
        e.stopPropagation();
        closeAllMenus();
        statusMenu.classList.toggle("open");
      });
      moreBtn.addEventListener("click", (e)=>{
        e.stopPropagation();
        closeAllMenus();
        moreMenu.classList.toggle("open");
      });

      refreshBtn.addEventListener("click", loadGrid);

      showBioCb.addEventListener("change",()=>{
        bioBox.classList.toggle("show", showBioCb.checked);
      });
      showHlCb.addEventListener("change",()=>{
        hlBox.classList.toggle("hidden", !showHlCb.checked);
        hlBox.setAttribute("aria-hidden", (!showHlCb.checked).toString());
      });

      function buildMenus(items){
        // Plataformas y estados únicos desde Notion
        const pset = new Set(); const sset = new Set();
        items.forEach(it=>{
          (it.platforms||[]).forEach(p=>pset.add(p));
          if(it.status) sset.add(it.status);
        });

        // Platform menu
        const pArr = ["All Platforms", ...Array.from(pset)];
        platformMenu.innerHTML = pArr.map(p=>`<div class="item" data-v="${p}">${p}</div>`).join("");
        platformMenu.querySelectorAll(".item").forEach(it=>{
          it.addEventListener("click", ()=>{
            currentPlatform = it.dataset.v;
            platformBtn.textContent = `${currentPlatform} ▾`;
            platformMenu.classList.remove("open");
            render();
          });
        });

        // Status menu
        const sArr = ["All Status", ...Array.from(sset)];
        statusMenu.innerHTML = sArr.map(s=>`<div class="item" data-v="${s}">${s}</div>`).join("");
        statusMenu.querySelectorAll(".item").forEach(it=>{
          it.addEventListener("click", ()=>{
            currentStatus = it.dataset.v;
            statusBtn.textContent = `${currentStatus} ▾`;
            statusMenu.classList.remove("open");
            render();
          });
        });
      }

      function render(){
        const items = ALL_ITEMS.filter(it=>{
          const passPlatform = (currentPlatform==="All Platforms") ||
                               (it.platforms||[]).includes(currentPlatform);
          const passStatus   = (currentStatus==="All Status") ||
                               (it.status === currentStatus);
          return passPlatform && passStatus;
        });

        if(items.length===0){
          gridEl.innerHTML = "";
          return;
        }

        gridEl.innerHTML = items.map(it=>{
          const title = (it.title||"").trim() || "Sin título";
          const date  = fmtDate(it.date);
          const chips = (it.tags||[]).slice(0,3);
          const media = it.image
            ? `<img src="${it.image}" alt="${title}" loading="lazy">`
            : (it.video ? `<video src="${it.video}" muted playsinline preload="metadata"></video>` : `<div style="background:#ddd;width:100%;height:100%"></div>`);

          return `
            <div class="tile" ${it.link ? `onclick="window.open('${it.link}','_blank')"`:""}>
              ${media}
              ${it.pinned ? `<div class="pin" title="Pinned">★</div>` : ``}
              ${chips.length? `<div class="chips">${chips.map(c=>`<span class="chip">${c}</span>`).join("")}</div>`:""}
              <div class="meta">
                <div>${title}</div>
                <div>${date}</div>
              </div>
            </div>
          `;
        }).join("");
      }

      async function loadGrid(){
        try{
          stateEl.classList.add("hidden");
          stateEl.textContent = "";

          const res = await fetch("/api/grid");
          if(!res.ok){
            const msg = `HTTP ${res.status}`;
            throw new Error(msg);
          }
          const data = await res.json();
          ALL_ITEMS = data.items || [];

          buildMenus(ALL_ITEMS);
          render();
        }catch(e){
          stateEl.textContent = `❌ Error al cargar: ${e.message}. Revisa /api/health y variables en Vercel.`;
          stateEl.classList.remove("hidden");
          gridEl.innerHTML = "";
        }
      }

      // Arranque
      loadGrid();
    </script>
  </body>
</html>
