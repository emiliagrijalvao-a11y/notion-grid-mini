<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Notion Grid Widget</title>
<style>
  :root{ --bg:#fff; --text:#111; --muted:#f5f5f5; --border:#e5e7eb; --blue-dark:#1B4B91; --container:936px; --gap:2px; }
  *{box-sizing:border-box}
  html,body{margin:0;background:var(--bg);color:var(--text);font-family:ui-sans-serif,system-ui,-apple-system,"Segoe UI",Roboto,Arial}
  .wrap{max-width:var(--container);margin:0 auto;padding:16px}
  .toolbar{display:flex;gap:12px;align-items:center;flex-wrap:wrap;border-bottom:1px solid var(--border);padding-bottom:12px;margin-bottom:12px}
  .btn{border:1px solid var(--border);background:#111;color:#fff;padding:10px 16px;font-weight:600;cursor:pointer;border-radius:6px;font-size:14px;display:inline-flex;align-items:center;gap:8px}
  .spacer{flex:1}
  .btn-dot{width:40px;height:40px;border:2px solid var(--border);background:#fff;cursor:pointer;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:18px;font-weight:bold}
  .dd{position:relative}
  .dd-toggle{border:2px solid var(--border);background:#fff;padding:10px 14px;min-width:180px;cursor:pointer;display:inline-flex;justify-content:space-between;align-items:center;gap:8px;border-radius:20px;font-weight:500;font-size:14px}
  .dd-toggle .count{color:#999;margin-left:4px;font-size:14px}
  .dd-menu{position:absolute;top:calc(100% + 8px);left:0;min-width:100%;background:#fff;border:1px solid var(--border);box-shadow:0 8px 24px rgba(0,0,0,.12);display:none;z-index:30;border-radius:12px;padding:8px}
  .dd.open .dd-menu{display:block}
  .dd-item{padding:10px 12px;cursor:pointer;display:flex;align-items:center;gap:10px;font-size:14px;border-radius:8px}
  .dd-item:hover{background:#f9fafb}
  .dd-item .radio{width:18px;height:18px;border:2px solid #ddd;border-radius:50%;position:relative;flex-shrink:0}
  .dd-item.active .radio{border-color:#111}
  .dd-item.active .radio::after{content:"";position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);width:8px;height:8px;background:#111;border-radius:50%}
  .dd-item .label{flex:1}
  .dd-item .count{color:#999;font-size:13px}
  .bio{display:none;border:1px solid var(--border);padding:16px;margin:10px 0 14px}
  .bio.visible{display:block}
  .bio-top{display:grid;grid-template-columns:64px 1fr;gap:12px;align-items:center;margin-bottom:6px}
  .bio-avatar{width:64px;height:64px;border-radius:50%;object-fit:cover;background:#eee}
  .bio-username{font-weight:800;font-size:16px}
  .bio-name{font-weight:600;margin-top:4px;font-size:14px;white-space:nowrap}
  .bio-lines{white-space:pre-wrap;margin:8px 0;line-height:1.5;font-size:14px}
  .bio-link a{color:var(--blue-dark);text-decoration:none;font-weight:500;font-size:14px}
  .menu{position:relative}
  .menu-panel{position:absolute;right:0;top:calc(100% + 8px);min-width:260px;background:#fff;border:1px solid var(--border);box-shadow:0 8px 24px rgba(0,0,0,.12);display:none;z-index:40;border-radius:12px;padding:10px}
  .menu.open .menu-panel{display:block}
  .menu-row{display:flex;align-items:center;justify-content:space-between;padding:10px;border-radius:8px;cursor:pointer}
  .menu-row:hover{background:#f9fafb}
  .switch{position:relative;width:44px;height:24px;background:#ddd;cursor:pointer;border-radius:12px}
  .switch::after{content:"";position:absolute;top:2px;left:2px;width:20px;height:20px;background:#fff;transition:transform .18s;border-radius:50%;box-shadow:0 1px 3px rgba(0,0,0,.2)}
  .switch.on{background:#111}.switch.on::after{transform:translateX(20px)}
  .menu-note{color:#6b7280;font-size:12px;padding:8px 0;margin-top:8px;border-top:1px solid var(--border);line-height:1.4}
  .grid{display:grid;grid-template-columns:repeat(3,1fr);gap:var(--gap);margin-top:0}
  .card{position:relative;background:#f5f5f5;cursor:pointer;overflow:hidden;aspect-ratio:4/5}
  .card-img,.card-video{width:100%;height:100%;object-fit:cover;display:block}
  .pin{position:absolute;top:8px;right:8px;font-size:16px;filter:drop-shadow(0 1px 3px rgba(0,0,0,.5));z-index:2}
  .play-icon{position:absolute;top:8px;left:8px;font-size:20px;color:#fff;filter:drop-shadow(0 1px 3px rgba(0,0,0,.6));z-index:2}
  .card-overlay{position:absolute;bottom:0;left:0;right:0;background:linear-gradient(to top, rgba(0,0,0,.7) 0%, transparent 100%);padding:10px;display:flex;justify-content:space-between;align-items:flex-end;color:#fff;opacity:0;transition:opacity .18s ease}
  .card:hover .card-overlay{opacity:1}
  .card-title{font-weight:600;font-size:13px;text-shadow:0 1px 2px rgba(0,0,0,0.5)}
  .card-date{font-size:12px;text-shadow:0 1px 2px rgba(0,0,0,0.5)}
  .card-placeholder{display:flex;align-items:center;justify-content:center;color:#aaa;font-size:14px;font-weight:500}
  .modal{position:fixed;inset:0;background:rgba(0,0,0,.85);display:none;align-items:center;justify-content:center;z-index:50;padding:20px}
  .modal.open{display:flex}
  .modal-content{max-width:90vw;max-height:90vh;display:flex;flex-direction:column;align-items:center;gap:12px}
  .modal-media{max-width:90vw;max-height:80vh;object-fit:contain;box-shadow:0 8px 32px rgba(0,0,0,.4)}
  .modal-caption{color:#fff;font-size:14px;line-height:1.5;max-width:600px;text-align:center;padding:0 20px}
  .modal-close{position:absolute;top:20px;right:20px;width:40px;height:40px;background:rgba(255,255,255,0.9);border:none;border-radius:50%;cursor:pointer;font-size:24px;font-weight:bold;display:flex;align-items:center;justify-content:center;color:#111}
  .banner{background:#fff3cd;border:1px solid #ffe69c;color:#7a5d00;padding:10px 12px;border-radius:8px;font-size:14px;margin:12px 0}
</style>
</head>
<body>
<main class="wrap">
  <div class="toolbar">
    <button id="btnRefresh" class="btn"><span style="font-size:16px">↻</span> Refresh</button>

    <div class="dd" id="ddPlatforms">
      <button class="dd-toggle" id="togglePlatforms">
        <span><span id="labelPlatforms">All Platforms</span><span id="countPlatforms" class="count"></span></span>
        <span>▾</span>
      </button>
      <div class="dd-menu" id="menuPlatforms"></div>
    </div>

    <div class="dd" id="ddStatus">
      <button class="dd-toggle" id="toggleStatus">
        <span><span id="labelStatus">All Status</span><span id="countStatus" class="count"></span></span>
        <span>▾</span>
      </button>
      <div class="dd-menu" id="menuStatus"></div>
    </div>

    <span class="spacer"></span>

    <div class="menu" id="menu">
      <button id="btnMenu" class="btn-dot" title="Options">···</button>
      <div class="menu-panel">
        <div class="menu-row" id="rowBio">
          <span style="font-weight:600">Show Bio</span>
          <div id="switchBio" class="switch" role="switch" aria-checked="true" tabindex="0"></div>
        </div>
        <div class="menu-note">
          To edit your bio for this widget, open your Account, find the widget, and click <strong>Edit</strong>.
        </div>
      </div>
    </div>
  </div>

  <div id="banner" class="banner" style="display:none"></div>

  <section id="bio" class="bio" aria-hidden="true">
    <div class="bio-top">
      <img id="bioAvatar" class="bio-avatar" alt="" style="display:none" />
      <div>
        <div id="bioUsername" class="bio-username"></div>
        <div id="bioName" class="bio-name"></div>
      </div>
    </div>
    <div id="bioLines" class="bio-lines"></div>
    <div class="bio-link"><a id="bioUrl" href="#" target="_blank" rel="noopener"></a></div>
  </section>

  <section id="grid" class="grid" aria-live="polite"></section>
</main>

<div id="modal" class="modal" aria-hidden="true">
  <button class="modal-close" id="modalClose">×</button>
  <div class="modal-content">
    <div id="modalMedia"></div>
    <div id="modalCaption" class="modal-caption"></div>
  </div>
</div>

<script>
  const state = {
    items: [],
    filters: { platforms: [], status: [] },
    selectedPlatform: null,
    selectedStatus: null,
    bio: null,
    showBio: true,
    ddOpen: null,
    menuOpen: false
  };

  const $grid = document.getElementById("grid");
  const $btnRefresh = document.getElementById("btnRefresh");
  const $ddPlatforms = document.getElementById("ddPlatforms");
  const $togglePlatforms = document.getElementById("togglePlatforms");
  const $menuPlatforms = document.getElementById("menuPlatforms");
  const $labelPlatforms = document.getElementById("labelPlatforms");
  const $countPlatforms = document.getElementById("countPlatforms");
  const $ddStatus = document.getElementById("ddStatus");
  const $toggleStatus = document.getElementById("toggleStatus");
  const $menuStatus = document.getElementById("menuStatus");
  const $labelStatus = document.getElementById("labelStatus");
  const $countStatus = document.getElementById("countStatus");
  const $menu = document.getElementById("menu");
  const $btnMenu = document.getElementById("btnMenu");
  const $rowBio = document.getElementById("rowBio");
  const $bio = document.getElementById("bio");
  const $switchBio = document.getElementById("switchBio");
  const $bioAvatar = document.getElementById("bioAvatar");
  const $bioUsername = document.getElementById("bioUsername");
  const $bioName = document.getElementById("bioName");
  const $bioLines = document.getElementById("bioLines");
  const $bioUrl = document.getElementById("bioUrl");
  const $modal = document.getElementById("modal");
  const $modalMedia = document.getElementById("modalMedia");
  const $modalCaption = document.getElementById("modalCaption");
  const $modalClose = document.getElementById("modalClose");
  const $banner = document.getElementById("banner");

  function openDD(which){ closeDD(); state.ddOpen = which; (which==="p"?$ddPlatforms:$ddStatus).classList.add("open"); }
  function closeDD(){ state.ddOpen=null; $ddPlatforms.classList.remove("open"); $ddStatus.classList.remove("open"); }
  function closeMenu(){ $menu.classList.remove("open"); state.menuOpen=false; }

  document.addEventListener("click",(e)=>{
    if(state.ddOpen){
      const el = state.ddOpen==="p"?$ddPlatforms:$ddStatus;
      if(!el.contains(e.target)) closeDD();
    }
    if(state.menuOpen && !$menu.contains(e.target)) closeMenu();
  });

  async function load(){
    try {
      const res = await fetch("/api/grid", { cache: "no-store" });
      const data = await res.json();
      if (!data.ok) {
        showBanner(data.error || "Unknown error");
        paintPlaceholders();
        return;
      }
      state.items = data.items || [];
      state.filters = data.filters || { platforms: [], status: [] };
      state.bio = data.bio || null;
      state.showBio = (localStorage.getItem("showBio") ?? "true")==="true";
      setSwitch($switchBio, state.showBio);
      renderBio();
      renderMenus();
      renderGrid();
      updateCounts();
    } catch (e) {
      showBanner(String(e.message || e));
      paintPlaceholders();
    }
  }

  function showBanner(msg){
    $banner.textContent = msg;
    $banner.style.display = "block";
  }

  function formatDate(dateStr){
    if(!dateStr) return "";
    const d = new Date(dateStr);
    if (isNaN(d)) return "";
    return d.toLocaleDateString("en-US",{month:"short",day:"numeric"});
  }

  function renderMenus(){
    const allP = state.items.filter(passStatus);
    const countByPlatform = {};
    allP.forEach(it => countByPlatform[it.platform] = (countByPlatform[it.platform]||0)+1);
    const P = ["All Platforms", ...(state.filters.platforms || [])];
    $menuPlatforms.innerHTML = P.map(x=>{
      const count = x==="All Platforms" ? allP.length : (countByPlatform[x]||0);
      const active = (x==="All Platforms" && !state.selectedPlatform) || state.selectedPlatform===x;
      return `<div class="dd-item ${active?'active':''}" data-v="${x}">
        <div class="radio"></div><div class="label">${x}</div><div class="count">(${count})</div></div>`;
    }).join("");
    [...$menuPlatforms.children].forEach(el => el.onclick = ()=>{
      const val = el.dataset.v;
      state.selectedPlatform = val==="All Platforms"? null : val;
      $labelPlatforms.textContent = val;
      closeDD(); renderGrid(); renderMenus(); updateCounts();
    });

    const allS = state.items.filter(passPlatform);
    const countByStatus = {};
    allS.forEach(it => countByStatus[it.status] = (countByStatus[it.status]||0)+1);
    const S = ["All Status", ...(state.filters.status || [])];
    $menuStatus.innerHTML = S.map(x=>{
      const count = x==="All Status" ? allS.length : (countByStatus[x]||0);
      const active = (x==="All Status" && !state.selectedStatus) || state.selectedStatus===x;
      return `<div class="dd-item ${active?'active':''}" data-v="${x}">
        <div class="radio"></div><div class="label">${x}</div><div class="count">(${count})</div></div>`;
    }).join("");
    [...$menuStatus.children].forEach(el => el.onclick = ()=>{
      const val = el.dataset.v;
      state.selectedStatus = val==="All Status"? null : val;
      $labelStatus.textContent = val;
      closeDD(); renderGrid(); renderMenus(); updateCounts();
    });
  }

  function passPlatform(it){ return !state.selectedPlatform || it.platform===state.selectedPlatform; }
  function passStatus(it){ return !state.selectedStatus || it.status===state.selectedStatus; }
  function passFilters(it){ return passPlatform(it) && passStatus(it); }

  function updateCounts(){
    const filtered = state.items.filter(passFilters);
    $countPlatforms.textContent = state.selectedPlatform ? `(${filtered.length})` : "";
    $countStatus.textContent = state.selectedStatus ? `(${filtered.length})` : "";
  }

  function paintPlaceholders(){
    $grid.innerHTML = Array(9).fill(0).map(()=>`<div class="card card-placeholder">No Content</div>`).join("");
  }

  function renderGrid(){
    const items = state.items.filter(passFilters);
    if(items.length===0){ paintPlaceholders(); return; }

    $grid.innerHTML = items.map(it=>{
      const pin = it.pinned ? `<div class="pin">📌</div>` : "";
      const playIcon = it.isVideo ? `<div class="play-icon">▶</div>` : "";
      let media = "";
      if(it.image){
        if(it.isVideo){
          media = `<video class="card-video" data-src="${it.image}" muted loop playsinline preload="none"></video>`;
        }else{
          media = `<img class="card-img" src="${it.image}" alt="${escapeHtml(it.title||"")}" loading="lazy" decoding="async" />`;
        }
      }else{
        media = `<div class="card-placeholder">No Content</div>`;
      }
      return `<article class="card" data-item='${JSON.stringify(it).replace(/'/g,"&apos;")}'>
        ${pin}${playIcon}${media}
        <div class="card-overlay">
          <div class="card-title">${escapeHtml(it.title||"")}</div>
          <div class="card-date">${formatDate(it.date)}</div>
        </div></article>`;
    }).join("");

    [...$grid.querySelectorAll("video")].forEach(vid=>{
      const card = vid.closest(".card");
      card.addEventListener("mouseenter", ()=>{
        if(!vid.src) vid.src = vid.dataset.src;
        vid.play().catch(()=>{});
      });
      card.addEventListener("mouseleave", ()=>{
        vid.pause(); vid.currentTime = 0;
      });
    });

    [...$grid.querySelectorAll(".card")].forEach(el=>{
      el.addEventListener("click", ()=>{
        const item = JSON.parse(el.getAttribute("data-item").replace(/&apos;/g,"'"));
        openModal(item);
      });
    });
  }

  function openModal(item){
    $modalMedia.innerHTML = "";
    if(item.isVideo && item.image){
      const v = document.createElement("video");
      v.src = item.image; v.controls = true; v.autoplay = true; v.className = "modal-media";
      $modalMedia.appendChild(v);
    }else if(item.image){
      const i = document.createElement("img");
      i.src = item.image; i.alt = item.title || ""; i.className = "modal-media";
      $modalMedia.appendChild(i);
    }
    $modalCaption.textContent = item.caption || "";
    $modal.classList.add("open"); $modal.setAttribute("aria-hidden","false");
  }
  function closeModalFn(){
    $modal.classList.remove("open"); $modal.setAttribute("aria-hidden","true");
    $modalMedia.innerHTML=""; $modalCaption.textContent="";
  }

  function renderBio(){
    if(!state.bio) return;
    $bioUsername.textContent = state.bio.username || "";
    $bioName.textContent = state.bio.name || "";
    $bioLines.textContent = (state.bio.textLines || []).join("\n");
    const cleanUrl = (state.bio.url || "").replace(/^https?:\/\//,"");
    $bioUrl.textContent = cleanUrl || "";
    $bioUrl.href = state.bio.url || "#";

    if(state.bio.avatar){
      $bioAvatar.src = state.bio.avatar;
      $bioAvatar.style.display = "block";
    }else{
      $bioAvatar.style.display = "none";
    }

    if(state.showBio){
      $bio.classList.add("visible");
      $bio.setAttribute("aria-hidden","false");
    }else{
      $bio.classList.remove("visible");
      $bio.setAttribute("aria-hidden","true");
    }
  }

  function setSwitch(el,on){ el.classList.toggle("on",!!on); el.setAttribute("aria-checked",!!on); }
  function toggleBio(){ state.showBio=!state.showBio; localStorage.setItem("showBio",String(state.showBio)); setSwitch($switchBio,state.showBio); renderBio(); }

  $btnRefresh.onclick = ()=>{
    state.selectedPlatform=null; state.selectedStatus=null;
    $labelPlatforms.textContent="All Platforms"; $labelStatus.textContent="All Status";
    load();
  };
  $togglePlatforms.onclick = e=>{ e.stopPropagation(); state.ddOpen==="p"?closeDD():openDD("p"); };
  $toggleStatus.onclick = e=>{ e.stopPropagation(); state.ddOpen==="s"?closeDD():openDD("s"); };

  $btnMenu.onclick = e=>{
    e.stopPropagation();
    if(state.menuOpen) closeMenu(); else { $menu.classList.add("open"); state.menuOpen=true; }
  };
  $rowBio.onclick = toggleBio;
  $switchBio.onclick = e=>{ e.stopPropagation(); toggleBio(); };

  $modal.onclick = e=>{ if(e.target===$modal) closeModalFn(); };
  $modalClose.onclick = closeModalFn;
  document.addEventListener("keydown", e=>{ if(e.key==="Escape" && $modal.classList.contains("open")) closeModalFn(); });

  const escapeHtml = s=>String(s).replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;").replaceAll('"',"&quot;").replaceAll("'","&#039;");

  load();
</script>
</body>
</html><!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Notion Grid Widget</title>
<style>
  :root{
    --bg:#fff; --text:#111; --muted:#f5f5f5; --border:#e5e7eb; --blue-dark:#1B4B91;
    --container:936px; --gap:2px;
  }
  *{box-sizing:border-box}
  html,body{margin:0;background:var(--bg);color:var(--text);font-family:ui-sans-serif,system-ui,-apple-system,"Segoe UI",Roboto,Arial}
  .wrap{max-width:var(--container);margin:0 auto;padding:16px}

  .toolbar{display:flex;gap:12px;align-items:center;flex-wrap:wrap;border-bottom:1px solid var(--border);padding-bottom:12px;margin-bottom:12px}
  .btn{border:1px solid var(--border);background:#111;color:#fff;padding:10px 16px;font-weight:600;cursor:pointer;border-radius:6px;font-size:14px;display:inline-flex;align-items:center;gap:8px}
  .spacer{flex:1}
  .btn-dot{width:40px;height:40px;border:2px solid var(--border);background:#fff;cursor:pointer;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:18px;font-weight:bold}

  .dd{position:relative}
  .dd-toggle{border:2px solid var(--border);background:#fff;padding:10px 14px;min-width:180px;cursor:pointer;display:inline-flex;justify-content:space-between;align-items:center;gap:8px;border-radius:20px;font-weight:500;font-size:14px}
  .dd-toggle .count{color:#999;margin-left:4px;font-size:14px}
  .dd-menu{position:absolute;top:calc(100% + 8px);left:0;min-width:100%;background:#fff;border:1px solid var(--border);box-shadow:0 8px 24px rgba(0,0,0,.12);display:none;z-index:30;border-radius:12px;padding:8px}
  .dd.open .dd-menu{display:block}
  .dd-item{padding:10px 12px;cursor:pointer;display:flex;align-items:center;gap:10px;font-size:14px;border-radius:8px}
  .dd-item:hover{background:#f9fafb}
  .dd-item .radio{width:18px;height:18px;border:2px solid #ddd;border-radius:50%;position:relative;flex-shrink:0}
  .dd-item.active .radio{border-color:#111}
  .dd-item.active .radio::after{content:"";position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);width:8px;height:8px;background:#111;border-radius:50%}
  .dd-item .label{flex:1}
  .dd-item .count{color:#999;font-size:13px}

  .bio{display:none;border:1px solid var(--border);padding:16px;margin:10px 0 14px}
  .bio.visible{display:block}
  .bio-top{display:grid;grid-template-columns:64px 1fr;gap:12px;align-items:center;margin-bottom:6px}
  .bio-avatar{width:64px;height:64px;border-radius:50%;object-fit:cover;background:#eee}
  .bio-username{font-weight:800;font-size:16px}
  .bio-name{font-weight:600;margin-top:4px;font-size:14px;white-space:nowrap}
  .bio-lines{white-space:pre-wrap;margin:8px 0;line-height:1.5;font-size:14px}
  .bio-link a{color:var(--blue-dark);text-decoration:none;font-weight:500;font-size:14px}

  .menu{position:relative}
  .menu-panel{position:absolute;right:0;top:calc(100% + 8px);min-width:260px;background:#fff;border:1px solid var(--border);box-shadow:0 8px 24px rgba(0,0,0,.12);display:none;z-index:40;border-radius:12px;padding:10px}
  .menu.open .menu-panel{display:block}
  .menu-row{display:flex;align-items:center;justify-content:space-between;padding:10px;border-radius:8px;cursor:pointer}
  .menu-row:hover{background:#f9fafb}
  .switch{position:relative;width:44px;height:24px;background:#ddd;cursor:pointer;border-radius:12px}
  .switch::after{content:"";position:absolute;top:2px;left:2px;width:20px;height:20px;background:#fff;transition:transform .18s;border-radius:50%;box-shadow:0 1px 3px rgba(0,0,0,.2)}
  .switch.on{background:#111}.switch.on::after{transform:translateX(20px)}
  .menu-note{color:#6b7280;font-size:12px;padding:8px 0;margin-top:8px;border-top:1px solid var(--border);line-height:1.4}

  .grid{display:grid;grid-template-columns:repeat(3,1fr);gap:var(--gap);margin-top:0}
  .card{position:relative;background:#f5f5f5;cursor:pointer;overflow:hidden;aspect-ratio:4/5}
  .card-img,.card-video{width:100%;height:100%;object-fit:cover;display:block}
  .pin{position:absolute;top:8px;right:8px;font-size:16px;filter:drop-shadow(0 1px 3px rgba(0,0,0,.5));z-index:2}
  .play-icon{position:absolute;top:8px;left:8px;font-size:20px;color:#fff;filter:drop-shadow(0 1px 3px rgba(0,0,0,.6));z-index:2}
  .card-overlay{position:absolute;bottom:0;left:0;right:0;background:linear-gradient(to top, rgba(0,0,0,.7) 0%, transparent 100%);padding:10px;display:flex;justify-content:space-between;align-items:flex-end;color:#fff;opacity:0;transition:opacity .18s ease}
  .card:hover .card-overlay{opacity:1}
  .card-title{font-weight:600;font-size:13px;text-shadow:0 1px 2px rgba(0,0,0,0.5)}
  .card-date{font-size:12px;text-shadow:0 1px 2px rgba(0,0,0,0.5)}
  .card-placeholder{display:flex;align-items:center;justify-content:center;color:#aaa;font-size:14px;font-weight:500}

  .modal{position:fixed;inset:0;background:rgba(0,0,0,.85);display:none;align-items:center;justify-content:center;z-index:50;padding:20px}
  .modal.open{display:flex}
  .modal-content{max-width:90vw;max-height:90vh;display:flex;flex-direction:column;align-items:center;gap:12px}
  .modal-media{max-width:90vw;max-height:80vh;object-fit:contain;box-shadow:0 8px 32px rgba(0,0,0,.4)}
  .modal-caption{color:#fff;font-size:14px;line-height:1.5;max-width:600px;text-align:center;padding:0 20px}
  .modal-close{position:absolute;top:20px;right:20px;width:40px;height:40px;background:rgba(255,255,255,0.9);border:none;border-radius:50%;cursor:pointer;font-size:24px;font-weight:bold;display:flex;align-items:center;justify-content:center;color:#111}
</style>
</head>
<body>
<main class="wrap">
  <div class="toolbar">
    <button id="btnRefresh" class="btn"><span style="font-size:16px">↻</span> Refresh</button>

    <div class="dd" id="ddPlatforms">
      <button class="dd-toggle" id="togglePlatforms">
        <span><span id="labelPlatforms">All Platforms</span><span id="countPlatforms" class="count"></span></span>
        <span>▾</span>
      </button>
      <div class="dd-menu" id="menuPlatforms"></div>
    </div>

    <div class="dd" id="ddStatus">
      <button class="dd-toggle" id="toggleStatus">
        <span><span id="labelStatus">All Status</span><span id="countStatus" class="count"></span></span>
        <span>▾</span>
      </button>
      <div class="dd-menu" id="menuStatus"></div>
    </div>

    <span class="spacer"></span>

    <div class="menu" id="menu">
      <button id="btnMenu" class="btn-dot" title="Options">···</button>
      <div class="menu-panel">
        <div class="menu-row" id="rowBio">
          <span style="font-weight:600">Show Bio</span>
          <div id="switchBio" class="switch" role="switch" aria-checked="true" tabindex="0"></div>
        </div>
        <div class="menu-note">
          To edit your bio for this widget, open your Account, find the widget, and click <strong>Edit</strong>.
        </div>
      </div>
    </div>
  </div>

  <section id="bio" class="bio" aria-hidden="true">
    <div class="bio-top">
      <img id="bioAvatar" class="bio-avatar" alt="" />
      <div>
        <div id="bioUsername" class="bio-username"></div>
        <div id="bioName" class="bio-name"></div>
      </div>
    </div>
    <div id="bioLines" class="bio-lines"></div>
    <div class="bio-link"><a id="bioUrl" href="#" target="_blank" rel="noopener"></a></div>
  </section>

  <section id="grid" class="grid" aria-live="polite"></section>
</main>

<div id="modal" class="modal" aria-hidden="true">
  <button class="modal-close" id="modalClose">×</button>
  <div class="modal-content">
    <div id="modalMedia"></div>
    <div id="modalCaption" class="modal-caption"></div>
  </div>
</div>

<script>
  const state = {
    items: [],
    filters: { platforms: [], status: [] },
    selectedPlatform: null,
    selectedStatus: null,
    bio: null,
    showBio: true,
    ddOpen: null,
    menuOpen: false
  };

  const $grid = document.getElementById("grid");
  const $btnRefresh = document.getElementById("btnRefresh");
  const $ddPlatforms = document.getElementById("ddPlatforms");
  const $togglePlatforms = document.getElementById("togglePlatforms");
  const $menuPlatforms = document.getElementById("menuPlatforms");
  const $labelPlatforms = document.getElementById("labelPlatforms");
  const $countPlatforms = document.getElementById("countPlatforms");
  const $ddStatus = document.getElementById("ddStatus");
  const $toggleStatus = document.getElementById("toggleStatus");
  const $menuStatus = document.getElementById("menuStatus");
  const $labelStatus = document.getElementById("labelStatus");
  const $countStatus = document.getElementById("countStatus");
  const $menu = document.getElementById("menu");
  const $btnMenu = document.getElementById("btnMenu");
  const $rowBio = document.getElementById("rowBio");
  const $bio = document.getElementById("bio");
  const $switchBio = document.getElementById("switchBio");
  const $bioAvatar = document.getElementById("bioAvatar");
  const $bioUsername = document.getElementById("bioUsername");
  const $bioName = document.getElementById("bioName");
  const $bioLines = document.getElementById("bioLines");
  const $bioUrl = document.getElementById("bioUrl");
  const $modal = document.getElementById("modal");
  const $modalMedia = document.getElementById("modalMedia");
  const $modalCaption = document.getElementById("modalCaption");
  const $modalClose = document.getElementById("modalClose");

  function openDD(which){ closeDD(); state.ddOpen = which; (which==="p"?$ddPlatforms:$ddStatus).classList.add("open"); }
  function closeDD(){ state.ddOpen=null; $ddPlatforms.classList.remove("open"); $ddStatus.classList.remove("open"); }
  function closeMenu(){ $menu.classList.remove("open"); state.menuOpen=false; }

  document.addEventListener("click",(e)=>{
    if(state.ddOpen){
      const el = state.ddOpen==="p"?$ddPlatforms:$ddStatus;
      if(!el.contains(e.target)) closeDD();
    }
    if(state.menuOpen && !$menu.contains(e.target)) closeMenu();
  });

  async function load(){
    const res = await fetch("/api/grid");
    const data = await res.json();
    if(!data.ok){ console.error(data.error); return; }

    state.items = data.items || [];
    state.filters = data.filters || { platforms: [], status: [] };
    state.bio = data.bio || null;

    state.showBio = (localStorage.getItem("showBio") ?? "true")==="true";
    setSwitch($switchBio, state.showBio);

    renderBio();
    renderMenus();
    renderGrid();
    updateCounts();
  }

  function formatDate(dateStr){
    if(!dateStr) return "";
    const d = new Date(dateStr);
    if (isNaN(d)) return "";
    return d.toLocaleDateString("en-US",{month:"short",day:"numeric"});
  }

  function renderMenus(){
    const allP = state.items.filter(passStatus);
    const countByPlatform = {};
    allP.forEach(it => countByPlatform[it.platform] = (countByPlatform[it.platform]||0)+1);
    const P = ["All Platforms", ...(state.filters.platforms || [])];
    $menuPlatforms.innerHTML = P.map(x=>{
      const count = x==="All Platforms" ? allP.length : (countByPlatform[x]||0);
      const active = (x==="All Platforms" && !state.selectedPlatform) || state.selectedPlatform===x;
      return `<div class="dd-item ${active?'active':''}" data-v="${x}">
        <div class="radio"></div><div class="label">${x}</div><div class="count">(${count})</div></div>`;
    }).join("");
    [...$menuPlatforms.children].forEach(el => el.onclick = ()=>{
      const val = el.dataset.v;
      state.selectedPlatform = val==="All Platforms"? null : val;
      $labelPlatforms.textContent = val;
      closeDD(); renderGrid(); renderMenus(); updateCounts();
    });

    const allS = state.items.filter(passPlatform);
    const countByStatus = {};
    allS.forEach(it => countByStatus[it.status] = (countByStatus[it.status]||0)+1);
    const S = ["All Status", ...(state.filters.status || [])];
    $menuStatus.innerHTML = S.map(x=>{
      const count = x==="All Status" ? allS.length : (countByStatus[x]||0);
      const active = (x==="All Status" && !state.selectedStatus) || state.selectedStatus===x;
      return `<div class="dd-item ${active?'active':''}" data-v="${x}">
        <div class="radio"></div><div class="label">${x}</div><div class="count">(${count})</div></div>`;
    }).join("");
    [...$menuStatus.children].forEach(el => el.onclick = ()=>{
      const val = el.dataset.v;
      state.selectedStatus = val==="All Status"? null : val;
      $labelStatus.textContent = val;
      closeDD(); renderGrid(); renderMenus(); updateCounts();
    });
  }

  function passPlatform(it){ return !state.selectedPlatform || it.platform===state.selectedPlatform; }
  function passStatus(it){ return !state.selectedStatus || it.status===state.selectedStatus; }
  function passFilters(it){ return passPlatform(it) && passStatus(it); }

  function updateCounts(){
    const filtered = state.items.filter(passFilters);
    $countPlatforms.textContent = state.selectedPlatform ? `(${filtered.length})` : "";
    $countStatus.textContent = state.selectedStatus ? `(${filtered.length})` : "";
  }

  function renderGrid(){
    const items = state.items.filter(passFilters);
    if(items.length===0){
      $grid.innerHTML = Array(12).fill(0).map(()=>`<div class="card card-placeholder">No Content</div>`).join("");
      return;
    }
    $grid.innerHTML = items.map(it=>{
      const pin = it.pinned ? `<div class="pin">📌</div>` : "";
      const playIcon = it.isVideo ? `<div class="play-icon">▶</div>` : "";
      let media = "";
      if(it.image){
        if(it.isVideo){
          media = `<video class="card-video" data-src="${it.image}" muted loop playsinline preload="none"></video>`;
        }else{
          media = `<img class="card-img" src="${it.image}" alt="${escapeHtml(it.title||"")}" loading="lazy" decoding="async" />`;
        }
      }else{
        media = `<div class="card-placeholder">No Content</div>`;
      }
      return `<article class="card" data-item='${JSON.stringify(it).replace(/'/g,"&apos;")}'>
        ${pin}${playIcon}${media}
        <div class="card-overlay">
          <div class="card-title">${escapeHtml(it.title||"")}</div>
          <div class="card-date">${formatDate(it.date)}</div>
        </div></article>`;
    }).join("");

    [...$grid.querySelectorAll("video")].forEach(vid=>{
      const card = vid.closest(".card");
      card.addEventListener("mouseenter", ()=>{
        if(!vid.src) vid.src = vid.dataset.src;
        vid.play().catch(()=>{});
      });
      card.addEventListener("mouseleave", ()=>{
        vid.pause(); vid.currentTime = 0;
      });
    });

    [...$grid.querySelectorAll(".card")].forEach(el=>{
      el.addEventListener("click", ()=>{
        const item = JSON.parse(el.getAttribute("data-item").replace(/&apos;/g,"'"));
        openModal(item);
      });
    });
  }

  function openModal(item){
    $modalMedia.innerHTML = "";
    if(item.isVideo && item.image){
      const v = document.createElement("video");
      v.src = item.image; v.controls = true; v.autoplay = true; v.className = "modal-media";
      $modalMedia.appendChild(v);
    }else if(item.image){
      const i = document.createElement("img");
      i.src = item.image; i.alt = item.title || ""; i.className = "modal-media";
      $modalMedia.appendChild(i);
    }
    $modalCaption.textContent = item.caption || "";
    $modal.classList.add("open"); $modal.setAttribute("aria-hidden","false");
  }
  function closeModalFn(){
    $modal.classList.remove("open"); $modal.setAttribute("aria-hidden","true");
    $modalMedia.innerHTML=""; $modalCaption.textContent="";
  }

  function renderBio(){
    if(!state.bio) return;
    $bioUsername.textContent = state.bio.username || "";
    $bioName.textContent = state.bio.name || "";
    $bioLines.textContent = (state.bio.textLines || []).join("\n");

    const cleanUrl = (state.bio.url || "").replace(/^https?:\/\//,"");
    $bioUrl.textContent = cleanUrl || "";
    $bioUrl.href = state.bio.url || "#";

    if(state.bio.avatar){
      $bioAvatar.src = state.bio.avatar;
      $bioAvatar.style.display = "block";
    }else{
      $bioAvatar.style.display = "none";
    }

    if(state.showBio){
      $bio.classList.add("visible");
      $bio.setAttribute("aria-hidden","false");
    }else{
      $bio.classList.remove("visible");
      $bio.setAttribute("aria-hidden","true");
    }
  }

  function setSwitch(el,on){ el.classList.toggle("on",!!on); el.setAttribute("aria-checked",!!on); }
  function toggleBio(){ state.showBio=!state.showBio; localStorage.setItem("showBio",String(state.showBio)); setSwitch($switchBio,state.showBio); renderBio(); }

  $btnRefresh.onclick = ()=>{
    state.selectedPlatform=null; state.selectedStatus=null;
    $labelPlatforms.textContent="All Platforms"; $labelStatus.textContent="All Status";
    load();
  };
  $togglePlatforms.onclick = e=>{ e.stopPropagation(); state.ddOpen==="p"?closeDD():openDD("p"); };
  $toggleStatus.onclick = e=>{ e.stopPropagation(); state.ddOpen==="s"?closeDD():openDD("s"); };

  $btnMenu.onclick = e=>{
    e.stopPropagation();
    if(state.menuOpen) closeMenu(); else { $menu.classList.add("open"); state.menuOpen=true; }
  };
  $rowBio.onclick = toggleBio;
  $switchBio.onclick = e=>{ e.stopPropagation(); toggleBio(); };

  $modal.onclick = e=>{ if(e.target===$modal) closeModalFn(); };
  $modalClose.onclick = closeModalFn;
  document.addEventListener("keydown", e=>{ if(e.key==="Escape" && $modal.classList.contains("open")) closeModalFn(); });

  const escapeHtml = s=>String(s).replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;").replaceAll('"',"&quot;").replaceAll("'","&#039;");

  load();
</script>
</body>
</html>
