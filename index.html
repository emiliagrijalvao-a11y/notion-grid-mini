<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Posts</title>
  <link rel="stylesheet" href="styles.css">
</head>
<body>
  <h1>Posts</h1>
  
  <button id="refresh-btn">Refresh</button>
  
  <div class="filters">
    <select id="client-filter">
      <option value="all">All Clients</option>
    </select>
    
    <select id="project-filter">
      <option value="all">All Projects</option>
    </select>
    
    <select id="brand-filter" disabled>
      <option value="all">All Brands</option>
    </select>
    
    <select id="platform-filter">
      <option value="all">All Platforms</option>
    </select>
    
    <select id="status-filter">
      <option value="published">Published Only</option>
      <option value="all">All Status</option>
    </select>
    
    <input type="text" id="search-input" placeholder="Buscar posts...">
  </div>

  <div id="error-message"></div>
  <div id="grid-container"></div>

  <script>
    let currentFilters = {
      client: 'all',
      project: 'all',
      brand: 'all',
      platform: 'all',
      status: 'published',
      search: ''
    };

    let schemaData = null;

    // Cargar schema primero
    async function loadSchema() {
      try {
        const response = await fetch('/api/schema');
        if (!response.ok) throw new Error('Error cargando schema');
        
        schemaData = await response.json();
        
        // Poblar filtros
        populateSelect('client-filter', schemaData.clients);
        populateSelect('platform-filter', schemaData.platforms);
        
      } catch (error) {
        console.error('Error en schema:', error);
      }
    }

    function populateSelect(selectId, items) {
      const select = document.getElementById(selectId);
      const firstOption = select.options[0];
      select.innerHTML = '';
      select.appendChild(firstOption);
      
      items.forEach(item => {
        const option = document.createElement('option');
        option.value = item.id || item.name;
        option.textContent = item.name;
        select.appendChild(option);
      });
    }

    // Cargar posts
    async function loadPosts() {
      const errorDiv = document.getElementById('error-message');
      const gridContainer = document.getElementById('grid-container');
      
      errorDiv.textContent = '';
      gridContainer.innerHTML = '<p>Cargando...</p>';

      try {
        const params = new URLSearchParams();
        
        Object.keys(currentFilters).forEach(key => {
          if (currentFilters[key] && currentFilters[key] !== 'all') {
            params.append(key, currentFilters[key]);
          }
        });

        const response = await fetch(`/api/grid?${params.toString()}`);
        
        if (!response.ok) {
          const errorData = await response.json();
          throw new Error(errorData.details || 'Error desconocido');
        }
        
        const data = await response.json();
        renderPosts(data.results);
        
      } catch (error) {
        console.error('Error completo:', error);
        errorDiv.textContent = `Error cargando posts: ${error.message}`;
        gridContainer.innerHTML = '';
      }
    }

    function renderPosts(posts) {
      const gridContainer = document.getElementById('grid-container');
      
      if (!posts || posts.length === 0) {
        gridContainer.innerHTML = '<p class="empty-state">No hay posts para mostrar</p>';
        return;
      }

      gridContainer.innerHTML = posts.map(post => {
        const name = post.properties.Name?.title?.[0]?.plain_text || 'Sin t√≠tulo';
        const date = post.properties.Created?.date?.start || '';
        const cover = post.cover?.file?.url || post.cover?.external?.url || '';
        
        return `
          <div class="post-card">
            ${cover ? `<img src="${cover}" alt="${name}">` : '<div class="no-image">Sin imagen</div>'}
            <div class="post-info">
              <h3>${name}</h3>
              <p>${date}</p>
            </div>
          </div>
        `;
      }).join('');
    }

    // Event listeners
    document.getElementById('refresh-btn').addEventListener('click', loadPosts);
    
    document.getElementById('client-filter').addEventListener('change', (e) => {
      currentFilters.client = e.target.value;
      
      // Filtrar proyectos y brands por cliente
      if (e.target.value !== 'all' && schemaData) {
        const filteredProjects = schemaData.projects.filter(p => p.client === e.target.value);
        const filteredBrands = schemaData.brands.filter(b => b.client === e.target.value);
        
        populateSelect('project-filter', filteredProjects);
        populateSelect('brand-filter', filteredBrands);
        document.getElementById('brand-filter').disabled = false;
      } else {
        populateSelect('project-filter', schemaData?.projects || []);
        document.getElementById('brand-filter').disabled = true;
        document.getElementById('brand-filter').value = 'all';
      }
      
      loadPosts();
    });

    document.getElementById('project-filter').addEventListener('change', (e) => {
      currentFilters.project = e.target.value;
      loadPosts();
    });

    document.getElementById('brand-filter').addEventListener('change', (e) => {
      currentFilters.brand = e.target.value;
      loadPosts();
    });

    document.getElementById('platform-filter').addEventListener('change', (e) => {
      currentFilters.platform = e.target.value;
      loadPosts();
    });

    document.getElementById('status-filter').addEventListener('change', (e) => {
      currentFilters.status = e.target.value;
      loadPosts();
    });

    let searchTimeout;
    document.getElementById('search-input').addEventListener('input', (e) => {
      clearTimeout(searchTimeout);
      searchTimeout = setTimeout(() => {
        currentFilters.search = e.target.value;
        loadPosts();
      }, 500);
    });

    // Inicializar
    loadSchema().then(() => loadPosts());
  </script>
</body>
</html>
