<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Grid</title>
  <style>
    /* ——— Reset & base ——— */
    *{box-sizing:border-box;margin:0;padding:0}
    html,body{background:#fff;color:#111;font:14px/1.4 -apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial,sans-serif}
    img{display:block;max-width:100%}

    /* ——— Layout ——— */
    .wrap{max-width:1100px;margin:18px auto;padding:0 16px}
    .toolbar{
      display:flex;align-items:center;gap:10px;margin-bottom:12px;
      position:sticky;top:0;background:#fff;z-index:10;padding:8px 0;
    }
    .btn{
      border:0;background:#111;color:#fff;padding:10px 14px;border-radius:8px;
      font-weight:600;cursor:pointer
    }
    .filters{display:flex;gap:8px;margin-left:6px}
    .select{
      appearance:none;border:1px solid #ddd;background:#fff;padding:10px 12px;border-radius:8px;
      min-width:150px;cursor:pointer
    }
    .grid{
      display:grid;gap:8px;
      grid-template-columns:repeat(3,1fr);
    }
    @media (max-width:900px){ .grid{grid-template-columns:repeat(2,1fr);} }
    @media (max-width:600px){ .grid{grid-template-columns:1fr;} }

    /* ——— Card IG ——— */
    .card{
      position:relative;overflow:hidden;background:#f2f2f2;
      /* IG: 4:5, sin bordes y sin radio */
      aspect-ratio:4/5;border:none;border-radius:0;
      cursor:pointer;
    }
    .thumb{width:100%;height:100%;object-fit:cover}

    /* ——— Overlay inferior (estilo IG) ——— */
    .meta{
      position:absolute;left:0;right:0;bottom:0;padding:10px 12px;color:#fff;
      background:linear-gradient(180deg,transparent 0%,rgba(0,0,0,.35) 40%,rgba(0,0,0,.65) 100%);
      display:flex;align-items:center;justify-content:space-between;gap:10px;
    }
    .title{font-size:15px;font-weight:700;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-width:82%}
    .date{font-size:13px;opacity:.85;white-space:nowrap}

    /* estado vacío / error */
    .state{color:#777;text-align:center;padding:40px 8px}
    .error{color:#b00020;background:#ffe9ec;border:1px solid #ffc2c9;border-radius:8px}

    /* opcional: hover para escritorio */
    @media (hover:hover){
      .meta{opacity:0;transition:opacity .2s ease}
      .card:hover .meta{opacity:1}
    }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="toolbar">
      <button id="btnRefresh" class="btn">Refresh</button>
      <div class="filters">
        <select id="filterPlatform" class="select"></select>
        <select id="filterStatus" class="select"></select>
      </div>
    </div>

    <div id="state" class="state">Cargando posts…</div>
    <div id="grid" class="grid" hidden></div>
  </div>

  <script>
    let ALL_ITEMS = [];
    let currentFilters = { platform: 'All', status: 'All' };

    function esc(s){ return (s||'').replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }
    function fmtDate(iso){
      try{
        const d = new Date(iso||Date.now());
        return d.toLocaleString('en-US',{month:'short',day:'numeric'}); // “Feb 25”
      }catch{return '';}
    }

    function uniqueValues(items, key){
      const set = new Set();
      items.forEach(i => { if(i[key]) set.add(i[key]); });
      return Array.from(set).sort();
    }

    function buildFilters(items){
      const selPlatform = document.getElementById('filterPlatform');
      const selStatus = document.getElementById('filterStatus');

      const platforms = ['All', ...uniqueValues(items,'platform')];
      const statuses  = ['All', ...uniqueValues(items,'status')];

      selPlatform.innerHTML = platforms.map(v=>`<option value="${esc(v)}">${esc(v)}</option>`).join('');
      selStatus.innerHTML   = statuses.map(v=>`<option value="${esc(v)}">${esc(v)}</option>`).join('');

      selPlatform.value = currentFilters.platform;
      selStatus.value   = currentFilters.status;

      selPlatform.onchange = () => { currentFilters.platform = selPlatform.value; render(); };
      selStatus.onchange   = () => { currentFilters.status   = selStatus.value; render(); };
    }

    function applyFilters(items){
      return items.filter(i =>
        (currentFilters.platform==='All' || i.platform===currentFilters.platform) &&
        (currentFilters.status==='All'   || i.status===currentFilters.status)
      );
    }

    function render(){
      const grid = document.getElementById('grid');
      const state = document.getElementById('state');

      const items = applyFilters(ALL_ITEMS);
      if(!items.length){
        grid.hidden = true;
        state.className = 'state';
        state.textContent = 'No hay elementos con esos filtros.';
        return;
      }

      grid.hidden = false;
      state.textContent = '';
      state.className = 'state';

      grid.innerHTML = items.map(item=>{
        const title = esc(item.title || ''); // IG no muestra título en la grilla, solo al pasar
        const date  = esc(fmtDate(item.date));
        const img   = esc(item.image || '');
        const link  = item.link ? `onclick="window.open('${esc(item.link)}','_blank')"` : '';

        return `
          <div class="card" ${link}>
            ${img ? `<img class="thumb" src="${img}" alt="${title}">` : ''}
            <div class="meta">
              <div class="title">${title}</div>
              <div class="date">${date}</div>
            </div>
          </div>
        `;
      }).join('');
    }

    async function load(){
      const state = document.getElementById('state');
      const grid  = document.getElementById('grid');

      try{
        state.className = 'state';
        state.textContent = 'Cargando posts…';
        grid.hidden = true;

        const res = await fetch('/api/grid');
        if(!res.ok) throw new Error('HTTP '+res.status);
        const data = await res.json();

        ALL_ITEMS = data.items || [];
        buildFilters(ALL_ITEMS);
        render();
      }catch(e){
        state.className = 'state error';
        state.textContent = '❌ Error al cargar: '+ e.message + '. Revisa /api/health y variables en Vercel.';
      }
    }

    document.getElementById('btnRefresh').onclick = load;

    load();
    setInterval(load, 5*60*1000);
  </script>
</body>
</html>
