<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Notion Grid Widget</title>
  <style>
    :root{
      --container: 936px;
      --gap: 2px;
      --cols: 3;
      --ink:#111; --muted:#69707a; --line:rgba(0,0,0,.08); --ghost:#f5f5f5;
      --overlay: linear-gradient(180deg, rgba(0,0,0,0) 0%, rgba(0,0,0,.55) 100%);
    }
    *{box-sizing:border-box}
    html,body{margin:0;background:#fff;color:var(--ink);font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Inter,Helvetica,Arial}
    a{color:inherit;text-decoration:none}
    button{font:inherit}

    .wrap{max-width:var(--container); margin:0 auto; padding:16px 12px 40px;}

    /* topbar */
    .topbar{display:flex;align-items:center;gap:10px;padding:4px 0 12px;}
    .iconbtn{display:inline-flex;align-items:center;gap:8px;border:none;background:#111;color:#fff;padding:10px 14px;border-radius:12px;cursor:pointer}
    .iconbtn .spin{display:inline-block;transition:transform .6s linear}
    .iconbtn.loading .spin{transform:rotate(360deg)}
    .ghost{background:var(--ghost);color:#111}
    .more{width:40px;height:40px;border-radius:12px;display:inline-grid;place-items:center}
    .topbar-spacer{flex:1}
    .grid-ico{width:18px;height:18px;display:inline-block;background:
      linear-gradient(#fff 0 0) left 50%/2px 100%,
      linear-gradient(#fff 0 0) 50% 50%/2px 100%,
      linear-gradient(#fff 0 0) right 50%/2px 100%,
      linear-gradient(#fff 0 0) 50% top/100% 2px,
      linear-gradient(#fff 0 0) 50% 50%/100% 2px,
      linear-gradient(#fff 0 0) 50% bottom/100% 2px; background-repeat:no-repeat; margin-right:6px}

    /* filtros (plegable) */
    .filters{overflow:hidden;max-height:0;transition:max-height .25s ease;border-bottom:1px solid var(--line)}
    .filters.open{max-height:380px}
    .filters-inner{display:grid;grid-template-columns:1fr;gap:12px;padding:8px 0 12px}
    .chipbar{display:flex;gap:12px}
    .chip{display:inline-flex;align-items:center;gap:8px;background:#f5f5f5;border:1px solid var(--line);border-radius:12px;padding:10px 12px;user-select:none}
    .chip .count{color:var(--muted);font-weight:600}
    .group{padding:4px 2px}
    .group h4{margin:0 0 6px 2px;font-size:13px;color:#555}
    .options{display:flex;flex-wrap:wrap;gap:8px}
    .pill{border:1px solid var(--line);padding:8px 12px;border-radius:999px;cursor:pointer}
    .pill.active{background:#111;color:#fff;border-color:#111}

    /* grid */
    .grid{margin-top:12px;display:grid;grid-template-columns:repeat(var(--cols),1fr);gap:var(--gap)}
    .card{position:relative;aspect-ratio:4/5;background:#eaeaea;overflow:hidden}
    .card img,.card video{width:100%;height:100%;object-fit:cover;display:block}

    /* overlay hover: título + fecha (tipo “Mar 11”) */
    .meta-overlay{position:absolute;inset:auto 0 0 0;background:var(--overlay);padding:10px 12px;
      display:flex;justify-content:space-between;align-items:flex-end;color:#fff;opacity:0;transform:translateY(8px);
      transition:.15s ease;font-weight:600;font-size:15px}
    .card:hover .meta-overlay{opacity:1;transform:translateY(0)}

    /* icons arriba derecha */
    .meta-icons{position:absolute;top:8px;right:8px;display:flex;gap:6px;pointer-events:none}
    .icon{width:22px;height:22px;display:grid;place-items:center;background:rgba(0,0,0,.6);color:#fff;border-radius:6px;font-size:12px}
    .icon[hidden]{display:none!important}

    /* menú ... */
    .menu{position:relative}
    .menu-panel{position:absolute;right:0;top:44px;min-width:240px;background:#fff;border:1px solid var(--line);
      border-radius:12px;box-shadow:0 10px 30px rgba(0,0,0,.08);padding:10px;display:none}
    .menu.open .menu-panel{display:block}
    .menu-row{display:flex;align-items:center;justify-content:space-between;padding:10px;border-radius:10px}
    .menu-row:hover{background:#f7f7f8}
    .switch{width:40px;height:24px;background:#e5e7eb;border-radius:999px;position:relative;transition:.2s}
    .switch::after{content:"";position:absolute;top:2px;left:2px;width:20px;height:20px;background:#fff;border-radius:999px;transition:.2s;box-shadow:0 1px 2px rgba(0,0,0,.2)}
    .switch.on{background:#111}.switch.on::after{left:18px}
    .menu-note{font-size:13px;color:#6b7280;padding:8px 10px 6px;border-top:1px solid var(--line);margin-top:6px}

    /* lightbox */
    .lightbox{position:fixed;inset:0;background:rgba(0,0,0,.75);display:none;align-items:center;justify-content:center;padding:24px;z-index:50}
    .lightbox.open{display:flex}
    .lightbox-inner{max-width:min(800px,90vw);max-height:90vh}
    .lightbox-figure img,.lightbox-figure video{width:100%;height:auto;max-height:80vh;object-fit:contain;display:block;background:#000}
    .lightbox-caption{color:#fff;font-size:14px;line-height:1.45;padding:10px 4px 0}

    /* placeholders */
    .placeholder{background:#efefef;color:#9aa1a8;display:grid;place-items:center;font-weight:600}

    /* bio/highlights (opcionales) */
    .bio,.highlights{display:none}
    .bio.show,.highlights.show{display:block;padding:12px 2px;border-bottom:1px solid var(--line);color:#32363a}
  </style>
</head>
<body>
  <div class="wrap">
    <!-- (opcional) Bio & Highlights -->
    <div id="bio" class="bio"></div>
    <div id="highlights" class="highlights"></div>

    <!-- Topbar -->
    <div class="topbar">
      <button id="refreshBtn" class="iconbtn"><span class="grid-ico"></span><span class="spin">↻</span> Refresh</button>
      <button id="filtersBtn" class="iconbtn ghost" title="Filtros">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" aria-hidden="true">
          <path d="M4 7h10m-8 0a2 2 0 1 0 4 0 2 2 0 1 0-4 0Zm0 10h14m-8 0a2 2 0 1 0 4 0 2 2 0 1 0-4 0Z" stroke="#111" stroke-width="2" stroke-linecap="round"/>
        </svg>
      </button>
      <div class="topbar-spacer"></div>
      <div id="menu" class="menu">
        <button id="menuBtn" class="iconbtn ghost more" title="Más"><strong>…</strong></button>
        <div class="menu-panel">
          <div class="menu-row"><span>Show Bio</span><div id="bioSwitch" class="switch" role="switch" aria-checked="false"></div></div>
          <div class="menu-row"><span>Show Highlights</span><div id="hlSwitch" class="switch" role="switch" aria-checked="false"></div></div>
          <div class="menu-note">Want to customize your bio or highlights? Go to your Account page, find your widget, click Edit.</div>
        </div>
      </div>
    </div>

    <!-- Filtros (plegable) -->
    <div id="filters" class="filters">
      <div class="filters-inner">
        <div class="chipbar">
          <div class="chip">All Platforms <span class="count" id="platformCount"></span></div>
          <div class="chip">All Status <span class="count" id="statusCount"></span></div>
        </div>
        <div class="group">
          <h4>Platforms</h4>
          <div id="platformOptions" class="options"></div>
        </div>
        <div class="group">
          <h4>Status</h4>
          <div id="statusOptions" class="options"></div>
        </div>
      </div>
    </div>

    <!-- Grid -->
    <div id="grid" class="grid" aria-live="polite" aria-busy="false"></div>
  </div>

  <!-- Lightbox -->
  <div id="lightbox" class="lightbox" aria-modal="true" role="dialog">
    <div class="lightbox-inner">
      <div class="lightbox-figure" id="lbFigure"></div>
      <div class="lightbox-caption" id="lbCaption"></div>
    </div>
  </div>

  <script>
  (() => {
    const gridEl = document.getElementById("grid");
    const refreshBtn = document.getElementById("refreshBtn");
    const filtersBtn = document.getElementById("filtersBtn");
    const filtersEl  = document.getElementById("filters");
    const menu       = document.getElementById("menu");
    const menuBtn    = document.getElementById("menuBtn");
    const bioSwitch  = document.getElementById("bioSwitch");
    const hlSwitch   = document.getElementById("hlSwitch");
    const bioEl      = document.getElementById("bio");
    const hlEl       = document.getElementById("highlights");
    const platformOptions = document.getElementById("platformOptions");
    const statusOptions   = document.getElementById("statusOptions");
    const platformCount   = document.getElementById("platformCount");
    const statusCount     = document.getElementById("statusCount");

    let selectedPlatforms = [];
    let selectedStatus = [];
    let dataset = [];
    const LIMIT = 12;

    const fmtDate = (iso) => {
      if (!iso) return "";
      try { return new Date(iso).toLocaleDateString("en-US",{month:"short",day:"numeric"}); }
      catch { return ""; }
    };

    const setLoading = (on) => {
      gridEl.setAttribute("aria-busy", String(on));
      refreshBtn.classList.toggle("loading", !!on);
    };

    const buildQuery = () => {
      const p = new URLSearchParams();
      if (selectedPlatforms.length) p.set("platform", selectedPlatforms.join(","));
      if (selectedStatus.length)    p.set("status", selectedStatus.join(","));
      p.set("limit", String(LIMIT));
      return p.toString() ? "/api/grid?"+p.toString() : "/api/grid";
    };

    async function loadGrid(){
      setLoading(true);
      try{
        const r = await fetch(buildQuery(), { cache:"no-store" });
        const json = await r.json();
        if (!json.ok) throw new Error(json.error || "API error");
        dataset = json.items || [];
        renderGrid(dataset);
        buildFilterLists(dataset);
        updateCounts();
      }catch(e){
        renderNoContent();
        console.error(e);
      }finally{
        setLoading(false);
      }
    }

    function renderNoContent(){
      gridEl.innerHTML = "";
      for (let i=0;i<LIMIT;i++){
        const ph = document.createElement("div");
        ph.className = "card placeholder";
        ph.textContent = "No Content";
        gridEl.appendChild(ph);
      }
    }

    function renderGrid(items){
      gridEl.innerHTML = "";
      if (!items.length){ renderNoContent(); return; }

      items.forEach((it) => {
        const card = document.createElement("div");
        card.className = "card";
        card.dataset.id = it.id;

        // Media
        if (it.media?.kind === "video"){
          const vid = document.createElement("video");
          vid.src = it.media.url;
          vid.muted = true; vid.loop = true; vid.playsInline = true; vid.preload = "none";
          card.appendChild(vid);
          card.addEventListener("mouseenter", ()=>{ vid.play().catch(()=>{}); });
          card.addEventListener("mouseleave", ()=>{ try{ vid.pause(); vid.currentTime = 0; }catch{} });
        } else {
          const img = document.createElement("img");
          img.src = it.media?.url || "";
          img.alt = it.title || "";
          img.loading = "lazy";
          card.appendChild(img);
        }

        // Overlay hover: Title + Date
        const meta = document.createElement("div");
        meta.className = "meta-overlay";
        const title = document.createElement("span");
        title.textContent = it.title || "";
        const date = document.createElement("span");
        date.textContent = fmtDate(it.publishDate);
        meta.appendChild(title); meta.appendChild(date);
        card.appendChild(meta);

        // Icons (pin / play)
        const icons = document.createElement("div");
        icons.className = "meta-icons";
        const pin = document.createElement("span");
        pin.className = "icon"; pin.textContent = "📌"; if (!it.pinned) pin.hidden = true;
        const play = document.createElement("span");
        play.className = "icon"; play.textContent = "▶"; if (it.media?.kind !== "video") play.hidden = true;
        icons.appendChild(pin); icons.appendChild(play);
        card.appendChild(icons);

        // Lightbox
        card.addEventListener("click", () => openLightbox(it));

        gridEl.appendChild(card);
      });
    }

    // Lightbox
    const lb = document.getElementById("lightbox");
    const lbFigure = document.getElementById("lbFigure");
    const lbCaption= document.getElementById("lbCaption");

    function openLightbox(it){
      lbFigure.innerHTML = "";
      if (it.media?.kind === "video"){
        const v = document.createElement("video");
        v.src = it.media.url; v.controls = true; v.autoplay = true; v.playsInline = true;
        lbFigure.appendChild(v);
      } else {
        const i = document.createElement("img");
        i.src = it.media?.url || ""; i.alt = it.title || "";
        lbFigure.appendChild(i);
      }
      lbCaption.textContent = it.caption || "";
      lb.classList.add("open");
    }
    lb.addEventListener("click",(e)=>{ if (e.target === lb) lb.classList.remove("open"); });

    // Filtros
    filtersBtn.addEventListener("click", ()=> filtersEl.classList.toggle("open"));

    function buildFilterLists(items){
      // Platforms
      const pset = new Set(items.flatMap(it => it.platforms || []));
      platformOptions.innerHTML = "";
      [...pset].sort().forEach(name => {
        const pill = document.createElement("button");
        pill.type = "button";
        pill.className = "pill"+(selectedPlatforms.includes(name) ? " active":"");
        pill.textContent = name;
        pill.addEventListener("click", ()=>{
          const i = selectedPlatforms.indexOf(name);
          if (i>=0) selectedPlatforms.splice(i,1); else selectedPlatforms.push(name);
          loadGrid();
        });
        platformOptions.appendChild(pill);
      });

      // Status
      const sset = new Set(items.map(it => it.status).filter(Boolean));
      statusOptions.innerHTML = "";
      [...sset].sort().forEach(name => {
        const pill = document.createElement("button");
        pill.type = "button";
        pill.className = "pill"+(selectedStatus.includes(name) ? " active":"");
        pill.textContent = name;
        pill.addEventListener("click", ()=>{
          const i = selectedStatus.indexOf(name);
          if (i>=0) selectedStatus.splice(i,1); else selectedStatus.push(name);
          loadGrid();
        });
        statusOptions.appendChild(pill);
      });
    }

    function updateCounts(){
      platformCount.textContent = selectedPlatforms.length ? `(${selectedPlatforms.length})` : "";
      statusCount.textContent   = selectedStatus.length ? `(${selectedStatus.length})` : "";
    }

    // Menú …
    menuBtn.addEventListener("click", ()=> menu.classList.toggle("open"));
    document.addEventListener("click",(e)=>{ if(!menu.contains(e.target) && e.target!==menuBtn) menu.classList.remove("open"); });

    const toggle = (el,on,target)=>{ el.classList.toggle("on",on); el.setAttribute("aria-checked",String(on)); if (target) target.classList.toggle("show",on); };
    bioSwitch.addEventListener("click", ()=>{ const on=!bioSwitch.classList.contains("on"); toggle(bioSwitch,on,bioEl); if(on && !bioEl.textContent) bioEl.textContent="@your_username · Your Display Name — short bio here…"; });
    hlSwitch.addEventListener("click",  ()=>{ const on=!hlSwitch.classList.contains("on");  toggle(hlSwitch,on,hlEl);  if(on && !hlEl.textContent)  hlEl.textContent="Highlights: add yours in Account → Edit."; });

    // inicio
    refreshBtn.addEventListener("click", loadGrid);
    loadGrid();
  })();
  </script>
</body>
</html>
